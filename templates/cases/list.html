{% extends "base.html" %}
{% block title %}Cases{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Cases</h2>
</div>

{# Stats row #}
<div class="row mb-4">
  <div class="col-6 col-md-3 mb-2">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-subtitle text-muted">Total Cases</h6>
            <div class="h4 mb-0">{{ stats_total|default:0 }}</div>
          </div>
          <div class="text-primary fs-2">
            <i class="bi bi-briefcase-fill"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3 mb-2">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-subtitle text-muted">Active</h6>
            <div class="h4 mb-0">{{ stats_active|default:0 }}</div>
          </div>
          <div class="text-success fs-2">
            <i class="bi bi-check-circle-fill"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3 mb-2">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-subtitle text-muted">Closed Won</h6>
            <div class="h4 mb-0">{{ stats_closed_won|default:0 }}</div>
          </div>
          <div class="text-info fs-2">
            <i class="bi bi-trophy-fill"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3 mb-2">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="card-subtitle text-muted">Contract Date Range</h6>
        <div class="h5 mb-0">
          {% if stats_first_contract and stats_last_contract %}
            {% if stats_first_contract == stats_last_contract %}
              {{ stats_first_contract|date:"m/d/Y" }}
            {% else %}
              {{ stats_first_contract|date:"m/d/Y" }} &mdash; {{ stats_last_contract|date:"m/d/Y" }}
            {% endif %}
          {% elif stats_first_contract %}
            {{ stats_first_contract|date:"m/d/Y" }}
          {% else %}
            -
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{# Filter form #}
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">Case #</label>
        <input type="text" name="case_number" class="form-control form-control-sm" placeholder="Search case #..." value="{{ case_number_search }}">
      </div>
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">Type</label>
        <select name="case_type" class="form-select form-select-sm">
          <option value="">All Types</option>
          {% for code, label in case_types %}
            <option value="{{ code }}" {% if current_type == code %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">Status</label>
        <select name="status" class="form-select form-select-sm">
          <option value="">All Statuses</option>
          {% for code, label in statuses %}
            <option value="{{ code }}" {% if current_status == code %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">County</label>
        <input type="text" name="county" class="form-control form-control-sm" placeholder="Search county..." value="{{ county_search }}">
      </div>
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">State</label>
        <input type="text" name="state" class="form-control form-control-sm" placeholder="State name..." value="{{ state_search }}">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-sm btn-primary">
          <i class="bi bi-funnel"></i> Filter
        </button>
        <a href="{% url 'cases:list' %}" class="btn btn-sm btn-outline-secondary ms-1">Clear</a>
      </div>
    </form>
  </div>
</div>

{# Results table #}
<div class="table-responsive">
  <table class="table table-striped table-hover table-sm align-middle">
    <thead class="table-dark">
      <tr>
        <th>Case #</th>
        <th>Address</th>
        <th>Type</th>
        <th>Status</th>
        <th class="d-none d-md-table-cell">County, State</th>
      </tr>
    </thead>
    <tbody>
      {% for case in object_list %}
      <tr>
        <td>
          <a href="{% url 'cases:detail' case.pk %}" class="fw-semibold link-primary link-underline-opacity-0 link-underline-opacity-100-hover">
            {{ case.case_number|default:case.pk }}
            <i class="bi bi-briefcase ms-1 small"></i>
          </a>
        </td>
        <td>
          {% if case.property_address %}
            {{ case.property_address }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          <span class="badge bg-secondary">{{ case.get_case_type_display }}</span>
        </td>
        <td>
          {% if case.status == "active" %}
            <span class="badge bg-success">Active</span>
          {% elif case.status == "monitoring" %}
            <span class="badge bg-info">Monitoring</span>
          {% elif case.status == "follow_up" %}
            <span class="badge bg-warning text-dark">Follow Up</span>
          {% elif case.status == "invoice_paid" %}
            <span class="badge bg-dark">Invoice Paid</span>
          {% elif case.status == "closed_won" %}
            <span class="badge bg-primary">Closed Won</span>
          {% elif case.status == "closed_lost" %}
            <span class="badge bg-danger">Closed Lost</span>
          {% endif %}
        </td>
        <td class="d-none d-md-table-cell">{{ case.county.name }}, {{ case.county.state.abbreviation }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" class="text-center text-muted py-4">No cases found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% include "includes/pagination.html" %}

{% endblock %}
