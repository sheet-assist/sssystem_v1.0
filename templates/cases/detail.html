{% extends "base.html" %}
{% load static %}
{% block title %}Case {{ object.case_number|default:object.pk }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Case {{ object.case_number|default:object.pk }}
    <span class="badge bg-secondary">{{ object.get_case_type_display }}</span>
    {% if object.status == "active" %}<span class="badge bg-success">Active</span>
    {% elif object.status == "monitoring" %}<span class="badge bg-info">Monitoring</span>
    {% elif object.status == "follow_up" %}<span class="badge bg-warning text-dark">Follow Up</span>
    {% elif object.status == "closed_won" %}<span class="badge bg-primary">Closed Won</span>
    {% elif object.status == "closed_lost" %}<span class="badge bg-danger">Closed Lost</span>
    {% endif %}
  </h2>
  <div>
    <a href="{% url 'cases:status_update' object.pk %}" class="btn btn-sm btn-outline-primary">Change Status</a>
    <a href="{% url 'cases:history' object.pk %}" class="btn btn-sm btn-outline-secondary">History</a>
    <a href="{% url 'cases:list' %}" class="btn btn-sm btn-outline-secondary">Back to List</a>
  </div>
</div>
<div class="mt-2">
  <a href="{% url 'cases:documents_page' object.pk %}" target="_blank" rel="noopener"
     class="btn btn-outline-success btn-sm me-1">
    <i class="bi bi-folder2-open"></i> Digital Folder
    {% with total=object.documents.count %}
    {% if total %}<span class="badge rounded-pill bg-success ms-1">{{ total }}</span>{% endif %}
    {% endwith %}
  </a>
  <a href="{% url 'cases:autodialer' object.pk %}" class="btn btn-outline-secondary btn-sm me-1">
    <i class="bi bi-telephone"></i> Autodialer
  </a>
  <a href="{% url 'cases:email' object.pk %}" class="btn btn-outline-secondary btn-sm me-1">
    <i class="bi bi-envelope"></i> Email
  </a>
</div>

<div class="row g-3 align-items-start">

  <!-- Timeline Sidebar (sticky right) -->
  <div class="col-lg-3 order-lg-last">
    <div class="card" style="position:sticky;top:66px;max-height:calc(100vh - 82px);overflow-y:auto;">
      <div class="card-header fw-semibold py-2" style="font-size:.85rem;">
        <i class="bi bi-diagram-3 me-1"></i> Lifecycle Timeline
      </div>
      <div class="card-body p-2">
        {% include "includes/_lifecycle_timeline.html" %}
      </div>
    </div>
  </div>

  <!-- Case Info -->
  <div class="col-lg-4 order-lg-first">
    <div class="card mb-3">
      <div class="card-header"><strong>Case Information</strong></div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-5">Property Address</dt>
          <dd class="col-sm-7">{{ object.property_address|default:"-" }}</dd>
          <dt class="col-sm-5">Case Number</dt>
          <dd class="col-sm-7">{{ object.case_number|default:"-" }}</dd>
          <dt class="col-sm-5">Parcel ID</dt>
          <dd class="col-sm-7">{{ object.parcel_id|default:"-" }}</dd>
          <dt class="col-sm-5">County</dt>
          <dd class="col-sm-7">{{ object.county.name }}, {{ object.county.state.abbreviation }}</dd>
          <dt class="col-sm-5">Assigned To</dt>
          <dd class="col-sm-7">{{ object.assigned_to.username|default:"Unassigned" }}</dd>
          <dt class="col-sm-5">Contract Date</dt>
          <dd class="col-sm-7">{{ object.contract_date|default:"-" }}</dd>
          <dt class="col-sm-5">Created</dt>
          <dd class="col-sm-7">{{ object.created_at|date:"M d, Y H:i" }}</dd>
        </dl>
      </div>
    </div>

    {% if object.contract_notes %}
    <div class="card mb-3">
      <div class="card-header"><strong>Contract Notes</strong></div>
      <div class="card-body">{{ object.contract_notes }}</div>
    </div>
    {% endif %}

    {% if object.prospect %}
    <div class="card mb-3">
      <div class="card-header"><strong>Source Prospect</strong></div>
      <div class="card-body">
        <a href="{% url 'prospects:detail' object.prospect.pk %}">
          {{ object.prospect }}
        </a>
      </div>
    </div>
    {% endif %}

    {# TDM Documents Card â€” syncs via the prospects app endpoints using prospect.pk #}
    {% if object.prospect %}
    {% include "prospects/_tdm_docs_fragment.html" with object=object.prospect tdm_downloaded_docs=tdm_downloaded_docs tdm_last_sync=tdm_last_sync %}
    {% endif %}
  </div>

  <!-- Notes & Follow-ups -->
  <div class="col-lg-5">
    <!-- Notes -->
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Notes</strong>
        <a href="{% url 'cases:note_add' object.pk %}" class="btn btn-sm btn-primary">Add Note</a>
      </div>
      <div class="card-body">
        {% for note in object.notes.all %}
        <div class="mb-2 pb-2 {% if not forloop.last %}border-bottom{% endif %}">
          <small class="text-muted">{{ note.created_at|date:"M d, Y H:i" }} by {{ note.author|default:"System" }}</small>
          <p class="mb-0">{{ note.content }}</p>
        </div>
        {% empty %}
        <p class="text-muted mb-0">No notes yet.</p>
        {% endfor %}
      </div>
    </div>

    <!-- Follow-ups -->
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Follow-ups</strong>
        <a href="{% url 'cases:followup_add' object.pk %}" class="btn btn-sm btn-primary">Add Follow-up</a>
      </div>
      <div class="card-body">
        {% for fu in object.followups.all %}
        <div class="mb-2 pb-2 {% if not forloop.last %}border-bottom{% endif %}">
          <div class="d-flex justify-content-between">
            <div>
              {% if fu.is_completed %}
                <span class="badge bg-success">Completed</span>
              {% else %}
                <span class="badge bg-warning text-dark">Due {{ fu.due_date }}</span>
              {% endif %}
              {% if fu.assigned_to %}<small class="text-muted ms-1">{{ fu.assigned_to.username }}</small>{% endif %}
            </div>
            {% if not fu.is_completed %}
            <form method="post" action="{% url 'cases:followup_complete' object.pk fu.pk %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-success">Complete</button>
            </form>
            {% endif %}
          </div>
          <p class="mb-0 mt-1">{{ fu.description }}</p>
        </div>
        {% empty %}
        <p class="text-muted mb-0">No follow-ups yet.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</div>


<script>
(function () {
  'use strict';

  function getCsrf() {
    var m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
  }

  function tdmSyncInit() {
    var btn = document.getElementById('sync-tdm-btn');
    if (!btn) return;

    var statusEl = document.getElementById('tdm-sync-status');

    function setStatus(msg, cls) {
      statusEl.className = 'small ' + (cls || 'text-muted');
      statusEl.textContent = msg;
    }

    function resetBtn(b) {
      b.disabled = false;
      b.innerHTML = '<i class="bi bi-arrow-repeat"></i> Sync TDM';
    }

    function poll(b, statusUrl, fragmentUrl) {
      fetch(statusUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(function (r) { return r.json(); })
        .then(function (data) {
          if (data.state === 'running') {
            setStatus('Syncing\u2026', 'text-info');
            setTimeout(function () { poll(b, statusUrl, fragmentUrl); }, 3000);
          } else if (data.state === 'completed') {
            var r = data.result || {};
            var newDocs = r.new_docs || 0;
            setStatus(
              'Done \u2014 ' + newDocs + ' new, ' + (r.downloaded || 0) + ' downloaded',
              newDocs > 0 ? 'text-success' : 'text-muted'
            );
            resetBtn(b);
            fetch(fragmentUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
              .then(function (r2) { return r2.text(); })
              .then(function (html) {
                var card = document.getElementById('tdm-docs-card');
                if (!card) return;
                var tmp = document.createElement('div');
                tmp.innerHTML = html;
                var newCard = tmp.firstElementChild;
                card.replaceWith(newCard);
                tdmSyncInit();
              });
          } else if (data.state === 'failed') {
            setStatus('Sync failed: ' + (data.error || 'unknown error'), 'text-danger');
            resetBtn(b);
          }
        })
        .catch(function () {
          setStatus('Status check failed.', 'text-danger');
          resetBtn(b);
        });
    }

    btn.addEventListener('click', function () {
      var b = this;
      b.disabled = true;
      b.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Syncing\u2026';
      setStatus('Starting\u2026', 'text-info');

      var syncUrl     = b.dataset.syncUrl;
      var statusUrl   = b.dataset.statusUrl;
      var fragmentUrl = b.dataset.fragmentUrl;

      fetch(syncUrl, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCsrf(),
          'X-Requested-With': 'XMLHttpRequest',
        },
      })
        .then(function (r) { return r.json(); })
        .then(function (data) {
          if (data.started) {
            poll(b, statusUrl, fragmentUrl);
          } else {
            setStatus(data.error || 'Could not start sync.', 'text-warning');
            resetBtn(b);
          }
        })
        .catch(function () {
          setStatus('Request failed.', 'text-danger');
          resetBtn(b);
        });
    });
  }

  document.addEventListener('DOMContentLoaded', tdmSyncInit);
})();
</script>

{% endblock %}
