{% extends "base.html" %}

{% block title %}{{ page_title|default:"Prospects" }}{% endblock %}

{% block content %}
{# Breadcrumbs - shown when navigating via type/state/county #}
{% if prospect_type and state_abbr and county_slug %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'prospects:type_select' %}">Prospects</a></li>
    <li class="breadcrumb-item"><a href="{% url 'prospects:state_select' prospect_type %}">{{ type_display }}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'prospects:county_select' prospect_type state_abbr %}">{{ state_abbr }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{% if county_obj %}{{ county_obj.name }}{% else %}{{ county_slug }}{% endif %}</li>
  </ol>
</nav>
{% endif %}

<style>.prospect-revenue-hidden { display: none !important; }</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">{{ page_title|default:"Prospects" }}{% if county_obj %} &mdash; {{ county_obj.name }}, {{ state_abbr }}{% endif %}</h2>
  {% if can_view_revenue %}
  <button type="button" id="toggleProspectListRevenue" class="btn btn-sm btn-outline-secondary">
    <i class="bi bi-eye"></i> Show Prospect Revenue
  </button>
  {% endif %}
</div>

{# Stats + Auction date range cards (all in one responsive row) #}
<div class="row mb-4">
  <div class="col-6 col-md-3 mb-2">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-subtitle text-muted">Total Prospects</h6>
            <div class="h4 mb-0">{{ stats_total|default:0 }}</div>
          </div>
          <div class="text-primary fs-2">
            <i class="bi bi-people-fill"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3 mb-2">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-subtitle text-muted">Qualified</h6>
            <div class="h4 mb-0">{{ stats_qualified|default:0 }}</div>
          </div>
          <div class="text-success fs-2">
            <i class="bi bi-check-circle-fill"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3 mb-2 prospect-revenue-col prospect-revenue-hidden">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-subtitle text-muted">Sum of Surplus</h6>
            <div class="h4 mb-0">${{ stats_surplus_sum|floatformat:2 }}</div>
          </div>
          <div class="text-info fs-2">
            <i class="bi bi-cash-stack"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3 mb-2">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="card-subtitle text-muted">Auction Date Range</h6>
        <div class="h5 mb-0">
          {% if stats_first_auction and stats_last_auction %}
            {% if stats_first_auction == stats_last_auction %}
              {{ stats_first_auction|date:"m/d/Y" }}
            {% else %}
              {{ stats_first_auction|date:"m/d/Y" }} &mdash; {{ stats_last_auction|date:"m/d/Y" }}
            {% endif %}
          {% elif stats_first_auction %}
            {{ stats_first_auction|date:"m/d/Y" }}
          {% else %}
            -
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{# Filter form #}
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <input type="hidden" name="sort" value="{{ current_sort }}">
      <input type="hidden" name="dir" value="{{ current_sort_dir }}">
      {% for field in filter.form %}
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">{{ field.label }}</label>
        {{ field }}
      </div>
      {% endfor %}
      <div class="col-auto">
        <button class="btn btn-sm btn-primary" type="submit">
          <i class="bi bi-funnel"></i> Filter
        </button>
        {% if prospect_type and state_abbr and county_slug %}
        <a href="{% url 'prospects:list' prospect_type state_abbr county_slug %}" class="btn btn-sm btn-outline-secondary ms-1">Clear</a>
        {% elif prospect_type %}
        <a href="{% url 'prospects:list_by_type' prospect_type %}" class="btn btn-sm btn-outline-secondary ms-1">Clear</a>
        {% else %}
        <a href="{% url 'prospects:list_all' %}" class="btn btn-sm btn-outline-secondary ms-1">Clear</a>
        {% endif %}
        <a class="btn btn-sm btn-outline-success ms-1" href="?{% for k,v in request.GET.items %}{% if k != 'page' and k != 'export' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}export=excel">
          <i class="bi bi-file-earmark-excel"></i> Export Excel
        </a>
      </div>
    </form>
  </div>
</div>

{# Results table #}
<div class="table-responsive">
  <table class="table table-striped table-hover table-sm align-middle">
    <thead class="table-dark">
      <tr>
        <th>
          <a href="{{ sort_urls.case_number }}" class="text-white text-decoration-none">
            Case #
            {% if active_sort_dirs.case_number == "asc" %}<i class="bi bi-arrow-up ms-1"></i>{% elif active_sort_dirs.case_number == "desc" %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
          </a>
        </th>
        <th class="d-none d-md-table-cell">Parcel ID</th>
        <th>Address</th>
        <th>
          <a href="{{ sort_urls.auction_date }}" class="text-white text-decoration-none">
            Auction Date
            {% if active_sort_dirs.auction_date == "asc" %}<i class="bi bi-arrow-up ms-1"></i>{% elif active_sort_dirs.auction_date == "desc" %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
          </a>
        </th>
        <th class="text-end d-none d-lg-table-cell">
          <a href="{{ sort_urls.surplus_amount }}" class="text-white text-decoration-none">
            Surplus
            {% if active_sort_dirs.surplus_amount == "asc" %}<i class="bi bi-arrow-up ms-1"></i>{% elif active_sort_dirs.surplus_amount == "desc" %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
          </a>
        </th>
        {% if can_view_revenue %}
        <th class="text-end d-none d-lg-table-cell prospect-revenue-col prospect-revenue-hidden">Revenue ({{ ss_revenue_tier }}%)</th>
        {% endif %}
        <th>
          <a href="{{ sort_urls.qualification_status }}" class="text-white text-decoration-none">
            Qualification
            {% if active_sort_dirs.qualification_status == "asc" %}<i class="bi bi-arrow-up ms-1"></i>{% elif active_sort_dirs.qualification_status == "desc" %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
          </a>
        </th>
        <th class="text-center d-none d-lg-table-cell">AC</th>
        <th class="text-center d-none d-lg-table-cell">TDM</th>
        <th class="d-none d-xl-table-cell">
          <a href="{{ sort_urls.workflow_status }}" class="text-white text-decoration-none">
            Workflow
            {% if active_sort_dirs.workflow_status == "asc" %}<i class="bi bi-arrow-up ms-1"></i>{% elif active_sort_dirs.workflow_status == "desc" %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
          </a>
        </th>
        <th class="d-none d-xl-table-cell">
          <a href="{{ sort_urls.assigned_to }}" class="text-white text-decoration-none">
            Assigned To
            {% if active_sort_dirs.assigned_to == "asc" %}<i class="bi bi-arrow-up ms-1"></i>{% elif active_sort_dirs.assigned_to == "desc" %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
          </a>
        </th>
        {% if user.profile.is_admin %}
        <th class="text-end d-none d-xl-table-cell">Actions</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for prospect in prospect_list %}
      <tr>
        <td class="d-none d-md-table-cell">
          <a href="{% url 'prospects:detail' prospect.pk %}" class="fw-semibold link-primary link-underline-opacity-0 link-underline-opacity-100-hover">
            {{ prospect.case_number }}
            <i class="bi bi-file-earmark-text ms-1 small"></i>
          </a>
        </td>
        <td>
          {% if prospect.parcel_id %}
            <a href="{% if prospect.parcel_url %}{{ prospect.parcel_url }}{% else %}https://apps.miamidadepa.gov/PropertySearch/#/?folio={{ prospect.parcel_id|cut:'-' }}{% endif %}"
               class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover fw-medium"
               target="_blank"
               rel="noopener"
              onclick="event.stopPropagation();">
              {{ prospect.parcel_id }}
              <i class="bi bi-globe2 ms-1 small"></i>
            </a>
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if prospect.property_address or prospect.city or prospect.zip_code %}
            <div>{{ prospect.property_address|default:"" }}</div>
            <div class="text-muted small">
              {% if prospect.city %}{{ prospect.city }}{% endif %}{% if prospect.city and prospect.zip_code %}, {% endif %}{% if prospect.zip_code %}{{ prospect.zip_code }}{% endif %}
            </div>
          {% else %}
            -
          {% endif %}
        </td>
        <td>{{ prospect.auction_date|date:"m/d/Y"|default:"-" }}</td>
        <td class="text-end d-none d-lg-table-cell">{% if prospect.surplus_amount %}${{ prospect.surplus_amount|floatformat:2 }}{% else %}-{% endif %}</td>
        {% if can_view_revenue %}
        <td class="text-end d-none d-lg-table-cell prospect-revenue-col prospect-revenue-hidden">{% if prospect.ss_revenue_amount %}${{ prospect.ss_revenue_amount|floatformat:2 }}{% else %}-{% endif %}</td>
        {% endif %}
        <td>
          {% if prospect.qualification_status == 'qualified' %}
            <span class="badge bg-success">Qualified</span>
          {% elif prospect.qualification_status == 'disqualified' %}
            <span class="badge bg-danger">Disqualified</span>
          {% else %}
            <span class="badge bg-warning text-dark">Pending</span>
          {% endif %}
        </td>
        <td class="text-center d-none d-lg-table-cell">
          {% if prospect.ack_url %}
            {% if user.profile.is_admin %}
              <a href="{{ prospect.ack_url }}" target="_blank" rel="noopener" onclick="event.stopPropagation();" class="text-success" title="Open AC URL">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </a>
            {% else %}
              <span class="text-success" title="AC URL available">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </span>
            {% endif %}
          {% else %}
            <span class="text-danger" title="AC URL not available">
              <i class="bi bi-x-circle-fill fs-5"></i>
            </span>
          {% endif %}
        </td>
        <td class="text-center d-none d-lg-table-cell">
          {% if prospect.tdm_url %}
            {% if user.profile.is_admin %}
              <a href="{{ prospect.tdm_url }}" target="_blank" rel="noopener" onclick="event.stopPropagation();" class="text-success" title="Open TDM URL">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </a>
            {% else %}
              <span class="text-success" title="TDM URL available">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </span>
            {% endif %}
          {% else %}
            <span class="text-danger" title="TDM URL not available">
              <i class="bi bi-x-circle-fill fs-5"></i>
            </span>
          {% endif %}
        </td>
        <td class="d-none d-xl-table-cell">
          {% if prospect.workflow_status == 'new' %}
            <span class="badge bg-secondary">New</span>
          {% elif prospect.workflow_status == 'assigned' %}
            <span class="badge bg-primary">Assigned</span>
          {% elif prospect.workflow_status == 'researching' %}
            <span class="badge bg-info text-dark">Researching</span>
          {% elif prospect.workflow_status == 'skip_tracing' %}
            <span class="badge bg-warning text-dark">Skip Trace</span>
          {% elif prospect.workflow_status == 'contacting' %}
            <span class="badge bg-warning">Contacting</span>
          {% elif prospect.workflow_status == 'contract_sent' %}
            <span class="badge bg-success">Contract Sent</span>
          {% elif prospect.workflow_status == 'converted' %}
            <span class="badge bg-success">Converted</span>
          {% elif prospect.workflow_status == 'dead' %}
            <span class="badge bg-danger">Dead</span>
          {% else %}
            <span class="badge bg-light text-dark">{{ prospect.workflow_status }}</span>
          {% endif %}
        </td>
        <td class="d-none d-xl-table-cell">{% if prospect.assigned_to %}{{ prospect.assigned_to.get_full_name|default:prospect.assigned_to.username }}{% else %}<span class="text-muted">Unassigned</span>{% endif %}</td>
        {% if user.profile.is_admin %}
        <td class="text-end d-none d-xl-table-cell">
          <button
            type="button"
            class="btn btn-outline-danger btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#confirmDeleteProspectModal"
            data-delete-url="{% url 'prospects:delete' prospect.pk %}"
            data-case-number="{{ prospect.case_number }}"
            data-next-url="{{ request.get_full_path }}"
            onclick="event.stopPropagation();"
          >
            <i class="bi bi-trash"></i> Delete
          </button>
        </td>
        {% endif %}
      </tr>
      {% empty %}
      <tr>
        <td colspan="{% if user.profile.is_admin and can_view_revenue %}12{% elif user.profile.is_admin %}11{% elif can_view_revenue %}11{% else %}10{% endif %}" class="text-center text-muted py-4">No prospects found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% include "includes/pagination.html" %}

<script>
  // Prospect Revenue Toggle
  (function () {
    const btn = document.getElementById('toggleProspectListRevenue');
    if (!btn) return;

    const KEY = 'prospects_list_show_revenue';

    function applyState(show) {
      document.querySelectorAll('.prospect-revenue-col').forEach(function (el) {
        el.classList.toggle('prospect-revenue-hidden', !show);
      });
      btn.innerHTML = show
        ? '<i class="bi bi-eye-slash"></i> Hide Prospect Revenue'
        : '<i class="bi bi-eye"></i> Show Prospect Revenue';
    }

    // Restore saved state (default: hidden)
    applyState(localStorage.getItem(KEY) === 'true');

    btn.addEventListener('click', function () {
      const nowVisible = !document.querySelector('.prospect-revenue-col')?.classList.contains('prospect-revenue-hidden');
      localStorage.setItem(KEY, String(!nowVisible));
      applyState(!nowVisible);
    });
  })();
</script>

{% if user.profile.is_admin %}
<div class="modal fade" id="confirmDeleteProspectModal" tabindex="-1" aria-labelledby="confirmDeleteProspectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteProspectModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Delete prospect <strong id="deleteProspectCaseRef">-</strong>? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteProspectForm" method="post" action="" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="next" id="deleteProspectNext" value="">
          <button type="submit" class="btn btn-danger btn-sm">
            <i class="bi bi-trash"></i> Delete
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("confirmDeleteProspectModal");
    if (!modal) return;

    modal.addEventListener("show.bs.modal", function (event) {
      const trigger = event.relatedTarget;
      if (!trigger) return;

      const action = trigger.getAttribute("data-delete-url") || "";
      const caseNumber = trigger.getAttribute("data-case-number") || "-";
      const nextUrl = trigger.getAttribute("data-next-url") || "";

      const form = document.getElementById("deleteProspectForm");
      const caseRef = document.getElementById("deleteProspectCaseRef");
      const nextInput = document.getElementById("deleteProspectNext");

      if (form) form.setAttribute("action", action);
      if (caseRef) caseRef.textContent = caseNumber;
      if (nextInput) nextInput.value = nextUrl;
    });
  });
</script>
{% endif %}
{% endblock %}

