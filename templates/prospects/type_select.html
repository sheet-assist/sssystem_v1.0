{% extends "base.html" %}

{% block title %}Select Prospect Type{% endblock %}

{% block extra_css %}
<style>
  .type-card { transition: transform 0.15s ease, box-shadow 0.15s ease; }
  .type-card:hover { transform: translateY(-3px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.12); }
  .compact-filter .form-label {
    font-size: .8 rem;
    margin-bottom: 0.2rem !important;
    padding-left: .35rem;
    white-space: nowrap;
  }
  .compact-filter .form-select,
  .compact-filter .form-control {
    height: calc(1.5em + 0.35rem + 2px);
    padding: 0.3rem 0.35rem;
    margin-right: 1.4rem;
    font-size: 0.8rem;
    min-width: 100px;
  }
  .compact-filter .form-select[name="prospect_type"] { min-width: 85px; }
  .compact-filter .form-control[type="date"] { min-width: 120px; }
  .compact-filter .btn {
    padding: 0.2rem 0.45rem;
    font-size: 0.8rem;
    white-space: nowrap;
  }
</style>
{% endblock %}

{% block content %}
<h2 class="mb-4">Prospects</h2>
<p class="text-muted mb-4">Select a prospect type to begin.</p>

<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-4">
  {% for item in type_cards %}
  <div class="col">
    <div
      class="card type-card h-100"
      style="cursor:pointer;"
      role="button"
      tabindex="0"
      title="View {{ item.label }}"
      onclick="window.location='{% url 'prospects:state_select' item.code %}';"
      onkeydown="if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); window.location='{% url 'prospects:state_select' item.code %}'; }"
    >
      <div class="card-header py-2 px-3 d-flex align-items-center justify-content-between {% if item.code == 'TD' %}bg-primary text-white{% elif item.code == 'TL' %}bg-success text-white{% elif item.code == 'SS' %}bg-danger text-white{% elif item.code == 'MF' %}bg-warning text-dark{% else %}bg-secondary text-white{% endif %}">
        <h6 class="mb-0"><i class="bi bi-tag-fill me-1"></i>{{ item.code }} {{ item.label }}</h6>
        <a
          href="{% url 'prospects:calendar' %}?type={{ item.code }}"
          class="{% if item.code == 'MF' %}text-dark{% else %}text-white{% endif %}"
          title="Open Calendar"
          onclick="event.stopPropagation();"
          aria-label="Open Calendar for {{ item.label }}"
        >
          <i class="bi bi-calendar3"></i>
        </a>
      </div>
      <div class="card-body text-center py-2 px-3 d-flex flex-column justify-content-center">
        <div class="mb-1 text-muted small">Qualified / Total</div>
        <div>
          {% if item.total_count > 0 %}
          <span class="badge text-dark border px-3 py-2" style="background-color: #fff3cd;">
            {{ item.qualified_count }}/{{ item.total_count }}
          </span>
          {% else %}
          <span class="text-muted">0/0</span>
          {% endif %}
        </div>
        <div class="mt-2 text-muted small">
          <strong>Auction Range:</strong>
          {% if item.first_auction and item.last_auction %}
            {% if item.first_auction == item.last_auction %}
              {{ item.first_auction|date:"m/d/Y" }}
            {% else %}
              {{ item.first_auction|date:"m/d/Y" }} - {{ item.last_auction|date:"m/d/Y" }}
            {% endif %}
          {% elif item.first_auction %}
            {{ item.first_auction|date:"m/d/Y" }}
          {% else %}
            -
          {% endif %}
        </div>
        <div class="mt-1 text-muted small">
          <strong>Total Surplus:</strong> ${{ item.total_surplus|floatformat:2 }}
        </div>
        <div class="py-1">
         <a href="{% url 'prospects:state_select' item.code %}" class="btn btn-sm {% if item.code == 'TD' %}btn-outline-primary{% elif item.code == 'TL' %}btn-outline-success{% elif item.code == 'SS' %}btn-outline-danger{% elif item.code == 'MF' %}btn-outline-warning{% else %}btn-outline-secondary{% endif %}" onclick="event.stopPropagation();">
            <i class="bi bi-geo-alt me-1"></i> View States
          </a>
          </div>
      </div>
     
    </div>
  </div>
  {% endfor %}
</div>

<div class="card mt-4 mb-3">
  <div class="card-body">
    <form method="get" id="type-select-filter-form" class="row g-1 align-items-end compact-filter flex-wrap flex-lg-nowrap">
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">{{ filter.form.qualification_status.label }}</label>
        {{ filter.form.qualification_status }}
      </div>
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">Type</label>
        <select name="prospect_type" class="form-select form-select-sm">
          <option value="">All Types</option>
          {% for code, label in types %}
          <option value="{{ code }}" {% if selected_prospect_type == code %}selected{% endif %}>{{ code }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">{{ filter.form.state.label }}</label>
        {{ filter.form.state }}
      </div>
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">{{ filter.form.county.label }}</label>
        {{ filter.form.county }}
      </div>
      {% for field in filter.form %}
      {% if field.name != "qualification_status" and field.name != "state" and field.name != "county" %}
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">{{ field.label }}</label>
        {{ field }}
      </div>
      {% endif %}
      {% endfor %}
      <div class="col-auto">
        <button class="btn btn-sm btn-primary" type="submit">
          <i class="bi bi-funnel"></i> Filter
        </button>
        <button id="clear-type-select-filters" class="btn btn-sm btn-outline-secondary ms-1" type="button">Clear</button>
        <a class="btn btn-sm btn-outline-success ms-1" href="?{% for k,v in request.GET.items %}{% if k != 'page' and k != 'export' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}export=excel">
          <i class="bi bi-file-earmark-excel"></i> Export Excel
        </a>
      </div>
    </form>
  </div>
</div>

{% if has_active_filters %}
<div class="row mb-3">
  <div class="col-12 col-md-6">
    <div class="card h-100">
      <div class="card-body py-2">
        <div class="small text-muted">Filtered Prospects</div>
        <div class="h5 mb-0">{{ filtered_total }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6 mt-2 mt-md-0">
    <div class="card h-100">
      <div class="card-body py-2">
        <div class="small text-muted">Filtered Total Surplus</div>
        <div class="h5 mb-0">${{ filtered_surplus|floatformat:2 }}</div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="table-responsive">
  <table class="table table-striped table-hover table-sm align-middle">
    <thead class="table-dark">
      <tr>
        <th>Case #</th>
        <th class="d-none d-md-table-cell">Type</th>
        <th class="d-none d-lg-table-cell">State</th>
        <th class="d-none d-lg-table-cell">County</th>
        <th class="d-none d-lg-table-cell">Parcel ID</th>
        <th>Address</th>
        <th>Auction Date</th>
        <th class="text-end d-none d-lg-table-cell">Surplus</th>
        <th>Qualification</th>
        <th class="text-center d-none d-lg-table-cell">AC</th>
        <th class="text-center d-none d-lg-table-cell">TDM</th>
        <th class="d-none d-xl-table-cell">Workflow</th>
        <th class="d-none d-xl-table-cell">Assigned To</th>
      </tr>
    </thead>
    <tbody>
      {% for prospect in prospect_list %}
      <tr>
        <td>
          <a href="{% url 'prospects:detail' prospect.pk %}" class="fw-semibold link-primary link-underline-opacity-0 link-underline-opacity-100-hover">
            {{ prospect.case_number }}
            <i class="bi bi-file-earmark-text ms-1 small"></i>
          </a>
        </td>
        <td class="d-none d-md-table-cell"><span class="badge bg-secondary">{{ prospect.get_prospect_type_display }}</span></td>
        <td class="d-none d-lg-table-cell">{{ prospect.county.state.abbreviation }}</td>
        <td class="d-none d-lg-table-cell">{{ prospect.county.name }}</td>
        <td class="d-none d-lg-table-cell">
          {% if prospect.parcel_id %}
            <a href="{% if prospect.parcel_url %}{{ prospect.parcel_url }}{% else %}https://apps.miamidadepa.gov/PropertySearch/#/?folio={{ prospect.parcel_id|cut:'-' }}{% endif %}"
               class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover fw-medium"
               target="_blank"
               rel="noopener">
              {{ prospect.parcel_id }}
              <i class="bi bi-globe2 ms-1 small"></i>
            </a>
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if prospect.property_address or prospect.city or prospect.zip_code %}
            <div>{{ prospect.property_address|default:"" }}</div>
            <div class="text-muted small">
              {% if prospect.city %}{{ prospect.city }}{% endif %}{% if prospect.city and prospect.zip_code %}, {% endif %}{% if prospect.zip_code %}{{ prospect.zip_code }}{% endif %}
            </div>
          {% else %}
            -
          {% endif %}
        </td>
        <td>{{ prospect.auction_date|date:"m/d/Y"|default:"-" }}</td>
        <td class="text-end d-none d-lg-table-cell">{% if prospect.surplus_amount %}${{ prospect.surplus_amount|floatformat:2 }}{% else %}-{% endif %}</td>
        <td>
          {% if prospect.qualification_status == 'qualified' %}
            <span class="badge bg-success">Qualified</span>
          {% elif prospect.qualification_status == 'disqualified' %}
            <span class="badge bg-danger">Disqualified</span>
          {% else %}
            <span class="badge bg-warning text-dark">Pending</span>
          {% endif %}
        </td>
        <td class="text-center d-none d-lg-table-cell">
          {% if prospect.ack_url %}
            {% if user.profile.is_admin %}
              <a href="{{ prospect.ack_url }}" target="_blank" rel="noopener" class="text-success" title="Open AC URL">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </a>
            {% else %}
              <span class="text-success" title="AC URL available">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </span>
            {% endif %}
          {% else %}
            <span class="text-danger" title="AC URL not available">
              <i class="bi bi-x-circle-fill fs-5"></i>
            </span>
          {% endif %}
        </td>
        <td class="text-center d-none d-lg-table-cell">
          {% if prospect.tdm_url %}
            {% if user.profile.is_admin %}
              <a href="{{ prospect.tdm_url }}" target="_blank" rel="noopener" class="text-success" title="Open TDM URL">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </a>
            {% else %}
              <span class="text-success" title="TDM URL available">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </span>
            {% endif %}
          {% else %}
            <span class="text-danger" title="TDM URL not available">
              <i class="bi bi-x-circle-fill fs-5"></i>
            </span>
          {% endif %}
        </td>
        <td class="d-none d-xl-table-cell">
          {% if prospect.workflow_status == 'new' %}
            <span class="badge bg-secondary">New</span>
          {% elif prospect.workflow_status == 'assigned' %}
            <span class="badge bg-primary">Assigned</span>
          {% elif prospect.workflow_status == 'researching' %}
            <span class="badge bg-info text-dark">Researching</span>
          {% elif prospect.workflow_status == 'skip_tracing' %}
            <span class="badge bg-warning text-dark">Skip Trace</span>
          {% elif prospect.workflow_status == 'contacting' %}
            <span class="badge bg-warning">Contacting</span>
          {% elif prospect.workflow_status == 'contract_sent' %}
            <span class="badge bg-success">Contract Sent</span>
          {% elif prospect.workflow_status == 'converted' %}
            <span class="badge bg-success">Converted</span>
          {% elif prospect.workflow_status == 'dead' %}
            <span class="badge bg-danger">Dead</span>
          {% else %}
            <span class="badge bg-light text-dark">{{ prospect.workflow_status }}</span>
          {% endif %}
        </td>
        <td class="d-none d-xl-table-cell">{% if prospect.assigned_to %}{{ prospect.assigned_to.get_full_name|default:prospect.assigned_to.username }}{% else %}<span class="text-muted">Unassigned</span>{% endif %}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="13" class="text-center text-muted py-4">No prospects found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% include "includes/pagination.html" %}
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const clearBtn = document.getElementById("clear-type-select-filters");
    const filterForm = document.getElementById("type-select-filter-form");
    if (!clearBtn || !filterForm) return;

    clearBtn.addEventListener("click", function () {
      Array.from(filterForm.elements).forEach(function (el) {
        if (!el.name || el.disabled) return;
        if (el.tagName === "SELECT") {
          el.value = "";
        } else if (el.type === "checkbox" || el.type === "radio") {
          el.checked = false;
        } else if (el.type !== "submit" && el.type !== "button") {
          el.value = "";
        }
      });
      filterForm.submit();
    });
  })();
</script>
{% endblock %}







