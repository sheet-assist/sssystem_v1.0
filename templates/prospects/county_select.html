{% extends "base.html" %}

{% block title %}Select County - {{ type_display }} - {{ state_abbr }}{% endblock %}
{% block extra_css %}
<style>
  .hover-card {
    transition: background-color 0.2s ease;
  }
  
  .hover-card:hover {
    background-color: #e3f2fd;
  }
</style>

{% endblock %}
{% block content %}
{# Breadcrumb #}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'prospects:type_select' %}">Prospects</a></li>
    <li class="breadcrumb-item"><a href="{% url 'prospects:state_select' prospect_type %}">{{ type_display }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ state_abbr }} &mdash; Select County</li>
  </ol>
</nav>

<h2 class="mb-4">{{ type_display }} &mdash; {{ state_abbr }} Counties</h2>

<div class="mb-3">
  <span class="text-muted small">Showing counties with prospect counts.</span>
</div>

<div class="mb-3">
  <input
    id="countySearchInput"
    type="text"
    class="form-control"
    placeholder="Search counties..."
    autocomplete="off"
  >
</div>

<div id="countyCardsGrid" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-2">
  {% for county in counties %}
  <div class="col searchable-item" data-search-text="{{ county.name|lower }}">
    <div
      class="card h-100 border-secondary hover-card"
      style="cursor:pointer;"
      role="button"
      tabindex="0"
      title="Filter list by {{ county.name }}"
      onclick="window.location='{% url 'prospects:county_select' prospect_type state_abbr %}?county={{ county.pk }}';"
      onkeydown="if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); window.location='{% url 'prospects:county_select' prospect_type state_abbr %}?county={{ county.pk }}'; }"
    >
      <div class="card-header py-2 px-3 d-flex align-items-center justify-content-between {% cycle 'bg-primary text-white' 'bg-success text-white' 'bg-danger text-white' 'bg-warning text-dark' %}">
        <h6 class="mb-0"><i class="bi bi-geo-alt-fill me-1"></i>{{ county.name }}</h6>
        <a
          href="{% url 'prospects:calendar' %}?type={{ prospect_type }}&state={{ state_abbr }}&county={{ county.slug }}"
          class="text-reset"
          title="Open Calendar"
          onclick="event.stopPropagation();"
          aria-label="Open Calendar for {{ county.name }}"
        >
          <i class="bi bi-calendar3"></i>
        </a>
      </div>
      <div class="card-body text-center py-2 px-3 d-flex flex-column justify-content-center">
        <div class="mb-1 text-muted small">Qualified / Total</div>
        <div>
          {% if county.total_count > 0 %}
          <span class="badge text-dark border px-3 py-2" style="background-color: #fff3cd;">
            {{ county.qualified_count }}/{{ county.total_count }}
          </span>
          {% else %}
          <span class="text-muted">0/0</span>
          {% endif %}
        </div>
        <div class="mt-2 text-muted small">
          <strong>Auction Range:</strong>
          {% if county.first_auction and county.last_auction %}
            {% if county.first_auction == county.last_auction %}
              {{ county.first_auction|date:"m/d/Y" }}
            {% else %}
              {{ county.first_auction|date:"m/d/Y" }} - {{ county.last_auction|date:"m/d/Y" }}
            {% endif %}
          {% elif county.first_auction %}
            {{ county.first_auction|date:"m/d/Y" }}
          {% else %}
            -
          {% endif %}
        </div>
        <div class="mt-1 text-muted small">
          <strong>Total Surplus:</strong> ${{ county.total_surplus|default:0|floatformat:2 }}
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="col-12">
    <div class="alert alert-info">
      No counties found with prospect counts for {{ state_abbr }}.
    </div>
  </div>
  {% endfor %}
</div>

<div class="card mt-4 mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      {% for field in filter.form %}
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">{{ field.label }}</label>
        {{ field }}
      </div>
      {% endfor %}
      <div class="col-auto">
        <button class="btn btn-sm btn-primary" type="submit">
          <i class="bi bi-funnel"></i> Filter
        </button>
        <a href="{% url 'prospects:county_select' prospect_type state_abbr %}" class="btn btn-sm btn-outline-secondary ms-1">Clear</a>
      </div>
    </form>
  </div>
</div>

{% if has_active_filters %}
<div class="row mb-3">
  <div class="col-12 col-md-6">
    <div class="card h-100">
      <div class="card-body py-2">
        <div class="small text-muted">Filtered Prospects</div>
        <div class="h5 mb-0">{{ filtered_total }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6 mt-2 mt-md-0">
    <div class="card h-100">
      <div class="card-body py-2">
        <div class="small text-muted">Filtered Total Surplus</div>
        <div class="h5 mb-0">${{ filtered_surplus|floatformat:2 }}</div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th>Case #</th>
        <th>State</th>
        <th>County</th>
        <th>Parcel ID</th>
        <th>Address</th>
        <th>Auction Date</th>
        <th class="text-end">Surplus</th>
        <th>Qualification</th>
        <th class="text-center">ACK</th>
        <th class="text-center">TDM</th>
        <th>Workflow</th>
      </tr>
    </thead>
    <tbody>
      {% for prospect in prospect_list %}
      <tr>
        <td>
          <a href="{% url 'prospects:detail' prospect.pk %}" class="fw-semibold link-primary link-underline-opacity-0 link-underline-opacity-100-hover">
            {{ prospect.case_number }}
            <i class="bi bi-file-earmark-text ms-1 small"></i>
          </a>
        </td>
        <td>{{ prospect.county.state.abbreviation }}</td>
        <td>{{ prospect.county.name }}</td>
        <td>
          {% if prospect.parcel_id %}
            <a href="{% if prospect.parcel_url %}{{ prospect.parcel_url }}{% else %}https://apps.miamidadepa.gov/PropertySearch/#/?folio={{ prospect.parcel_id|cut:'-' }}{% endif %}"
               class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover fw-medium"
               target="_blank"
               rel="noopener">
              {{ prospect.parcel_id }}
              <i class="bi bi-globe2 ms-1 small"></i>
            </a>
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if prospect.property_address or prospect.city or prospect.zip_code %}
            <div>{{ prospect.property_address|default:"" }}</div>
            <div class="text-muted small">
              {% if prospect.city %}{{ prospect.city }}{% endif %}{% if prospect.city and prospect.zip_code %}, {% endif %}{% if prospect.zip_code %}{{ prospect.zip_code }}{% endif %}
            </div>
          {% else %}
            -
          {% endif %}
        </td>
        <td>{{ prospect.auction_date|date:"m/d/Y"|default:"-" }}</td>
        <td class="text-end">{% if prospect.surplus_amount %}${{ prospect.surplus_amount|floatformat:2 }}{% else %}-{% endif %}</td>
        <td>
          {% if prospect.qualification_status == 'qualified' %}
            <span class="badge bg-success">Qualified</span>
          {% elif prospect.qualification_status == 'disqualified' %}
            <span class="badge bg-danger">Disqualified</span>
          {% else %}
            <span class="badge bg-warning text-dark">Pending</span>
          {% endif %}
        </td>
        <td class="text-center">
          {% if prospect.ack_url %}
            {% if user.profile.is_admin %}
              <a href="{{ prospect.ack_url }}" target="_blank" rel="noopener" class="text-success" title="Open ACK URL">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </a>
            {% else %}
              <span class="text-success" title="ACK URL available">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </span>
            {% endif %}
          {% else %}
            <span class="text-danger" title="ACK URL not available">
              <i class="bi bi-x-circle-fill fs-5"></i>
            </span>
          {% endif %}
        </td>
        <td class="text-center">
          {% if prospect.tdm_url %}
            {% if user.profile.is_admin %}
              <a href="{{ prospect.tdm_url }}" target="_blank" rel="noopener" class="text-success" title="Open TDM URL">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </a>
            {% else %}
              <span class="text-success" title="TDM URL available">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </span>
            {% endif %}
          {% else %}
            <span class="text-danger" title="TDM URL not available">
              <i class="bi bi-x-circle-fill fs-5"></i>
            </span>
          {% endif %}
        </td>
        <td>
          {% if prospect.workflow_status == 'new' %}
            <span class="badge bg-secondary">New</span>
          {% elif prospect.workflow_status == 'assigned' %}
            <span class="badge bg-primary">Assigned</span>
          {% elif prospect.workflow_status == 'researching' %}
            <span class="badge bg-info text-dark">Researching</span>
          {% elif prospect.workflow_status == 'skip_tracing' %}
            <span class="badge bg-warning text-dark">Skip Trace</span>
          {% elif prospect.workflow_status == 'contacting' %}
            <span class="badge bg-warning">Contacting</span>
          {% elif prospect.workflow_status == 'contract_sent' %}
            <span class="badge bg-success">Contract Sent</span>
          {% elif prospect.workflow_status == 'converted' %}
            <span class="badge bg-success">Converted</span>
          {% elif prospect.workflow_status == 'dead' %}
            <span class="badge bg-danger">Dead</span>
          {% else %}
            <span class="badge bg-light text-dark">{{ prospect.workflow_status }}</span>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="11" class="text-center text-muted py-4">No prospects found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% include "includes/pagination.html" %}

<script>
  (function () {
    const input = document.getElementById("countySearchInput");
    const items = Array.from(document.querySelectorAll("#countyCardsGrid .searchable-item"));
    if (!input || !items.length) return;

    input.addEventListener("input", function () {
      const q = input.value.trim().toLowerCase();
      items.forEach(function (item) {
        const text = item.getAttribute("data-search-text") || "";
        item.style.display = text.includes(q) ? "" : "none";
      });
    });
  })();
</script>
{% endblock %}
