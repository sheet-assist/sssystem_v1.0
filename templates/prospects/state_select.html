{% extends "base.html" %}

{% block title %}Select State - {{ type_display }}{% endblock %}
{% block extra_css %}
<style>
  .hover-card {
    transition: background-color 0.2s ease;
  }
  
  .hover-card:hover {
    background-color: #e3f2fd;
  }
</style>
{% endblock %}

{% block content %}
{# Breadcrumb #}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'prospects:type_select' %}">Prospects</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ type_display }}</li>
    <li class="breadcrumb-item active" aria-current="page">Select State</li>
  </ol>
</nav>

<h2 class="mb-4">{{ type_display }} &mdash; Select State</h2>
<div class="mb-3">
  <a href="{% url 'prospects:calendar' %}?type={{ prospect_type }}" class="btn btn-outline-primary btn-sm">
    <i class="bi bi-calendar3 me-1"></i> Open Prospect Calendar
  </a>
</div>
<div class="mb-3">
  {% if show_all %}
  <a href="{% url 'prospects:state_select' prospect_type %}" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-funnel me-1"></i> Show States With Count
  </a>
  {% else %}
  <a href="{% url 'prospects:state_select' prospect_type %}?show_all=1" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-list-ul me-1"></i> Show All States
  </a>
  {% endif %}
</div>

<div class="mb-3">
  <input
    id="stateSearchInput"
    type="text"
    class="form-control"
    placeholder="Search states..."
    autocomplete="off"
  >
</div>

<div id="stateCardsGrid" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
  {% for state in states %}
  <div class="col searchable-item" data-search-text="{{ state.name|lower }} {{ state.abbreviation|lower }}">
    <div class="card h-100 border-secondary hover-card">
      <div class="card-body text-center d-flex flex-column">
        <h5 class="card-title text-dark mb-1">{{ state.name }}</h5>
        <span class="badge bg-secondary mb-2 align-self-center">{{ state.abbreviation }}</span>
        <div class="mb-2">
          {% if state.total_count > 0 %}
          <span class="badge text-dark border" style="background-color: #fff3cd;">
            {{ state.qualified_count }}/{{ state.total_count }}
          </span>
          {% endif %}
        </div>
        <div class="mt-auto d-grid gap-2">
          <a href="{% url 'prospects:county_select' prospect_type state.abbreviation %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-geo-alt me-1"></i> Counties
          </a>
          <a href="{% url 'prospects:calendar' %}?type={{ prospect_type }}&state={{ state.abbreviation }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-calendar3 me-1"></i> Calendar
          </a>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="col-12">
    <div class="alert alert-info">
      No states found{% if not show_all %} with prospect counts{% endif %}.
    </div>
  </div>
  {% endfor %}
</div>

<script>
  (function () {
    const input = document.getElementById("stateSearchInput");
    const items = Array.from(document.querySelectorAll("#stateCardsGrid .searchable-item"));
    if (!input || !items.length) return;

    input.addEventListener("input", function () {
      const q = input.value.trim().toLowerCase();
      items.forEach(function (item) {
        const text = item.getAttribute("data-search-text") || "";
        item.style.display = text.includes(q) ? "" : "none";
      });
    });
  })();
</script>
{% endblock %}
