{% extends "base.html" %}

{% block title %}Select State - {{ type_display }}{% endblock %}
{% block extra_css %}
<style>
  .hover-card {
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }
  
  .hover-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.12);
  }

  .state-card {
    border-width: 1px;
    border-style: solid;
  }

  .state-card .card-header {
    border-bottom: 1px solid rgba(0,0,0,.08);
  }

  .state-card.theme-ocean {
    background: linear-gradient(180deg, #eef6ff 0%, #ffffff 100%);
    border-color: #9ec5fe;
  }

  .state-card.theme-forest {
    background: linear-gradient(180deg, #edf9f1 0%, #ffffff 100%);
    border-color: #a3cfbb;
  }

  .state-card.theme-sand {
    background: linear-gradient(180deg, #fff7e8 0%, #ffffff 100%);
    border-color: #ffda9e;
  }

  .state-card.theme-coral {
    background: linear-gradient(180deg, #fff0f0 0%, #ffffff 100%);
    border-color: #f1aeb5;
  }
</style>
{% endblock %}

{% block content %}
{# Breadcrumb #}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'prospects:type_select' %}">Prospects</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ type_display }}</li>
    <li class="breadcrumb-item active" aria-current="page">Select State</li>
  </ol>
</nav>

<h2 class="mb-4">{{ type_display }} &mdash; Select State</h2>
<div class="mb-3">
  <a href="{% url 'prospects:calendar' %}?type={{ prospect_type }}" class="btn btn-outline-primary btn-sm">
    <i class="bi bi-calendar3 me-1"></i> Open Prospect Calendar
  </a>
</div>
<div class="mb-3">
  <span class="text-muted small">Showing states with prospect counts.</span>
</div>

<div class="mb-3">
  <input
    id="stateSearchInput"
    type="text"
    class="form-control"
    placeholder="Search states..."
    autocomplete="off"
  >
</div>

<div id="stateCardsGrid" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
  {% for state in states %}
  <div class="col searchable-item" data-search-text="{{ state.name|lower }} {{ state.abbreviation|lower }}">
    <div
      class="card h-100 hover-card state-card {% cycle 'theme-ocean' 'theme-forest' 'theme-sand' 'theme-coral' %}"
      style="cursor:pointer;"
      role="button"
      tabindex="0"
      title="Filter list by {{ state.name }}"
      onclick="window.location='{% url 'prospects:state_select' prospect_type %}?state={{ state.pk }}';"
      onkeydown="if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); window.location='{% url 'prospects:state_select' prospect_type %}?state={{ state.pk }}'; }"
    >
      <div class="card-header py-2 px-3 d-flex align-items-center justify-content-between {% cycle 'bg-primary text-white' 'bg-success text-white' 'bg-danger text-white' 'bg-warning text-dark' %}">
        <h6 class="mb-0"><i class="bi bi-geo-alt-fill me-1"></i>{{ state.abbreviation }} {{ state.name }}</h6>
        <div class="d-flex align-items-center gap-2">
          <a
            href="{% url 'prospects:calendar' %}?type={{ prospect_type }}&state={{ state.abbreviation }}"
            class="text-reset"
            title="Open Calendar"
            onclick="event.stopPropagation();"
            aria-label="Open Calendar for {{ state.name }}"
          >
            <i class="bi bi-calendar3"></i>
          </a>
        </div>
      </div>
      <div class="card-body text-center py-2 px-3 d-flex flex-column justify-content-center">
        <div class="mb-1 text-muted small">Qualified / Total</div>
        <div>
          {% if state.total_count > 0 %}
          <span class="badge text-dark border px-3 py-2" style="background-color: #fff3cd;">
            {{ state.qualified_count }}/{{ state.total_count }}
          </span>
          {% else %}
          <span class="text-muted">0/0</span>
          {% endif %}
        </div>
        <div class="mt-2 text-muted small">
          <strong>Auction Range:</strong>
          {% if state.first_auction and state.last_auction %}
            {% if state.first_auction == state.last_auction %}
              {{ state.first_auction|date:"m/d/Y" }}
            {% else %}
              {{ state.first_auction|date:"m/d/Y" }} - {{ state.last_auction|date:"m/d/Y" }}
            {% endif %}
          {% elif state.first_auction %}
            {{ state.first_auction|date:"m/d/Y" }}
          {% else %}
            -
          {% endif %}
        </div>
        <div class="mt-1 text-muted small">
          <strong>Total Surplus:</strong> ${{ state.total_surplus|default:0|floatformat:2 }}
        </div>
        {% if can_view_revenue %}
        <div class="mt-1 text-muted small">
          <strong>Total Revenue:</strong> ${{ state.total_revenue|default:0|floatformat:2 }}
        </div>
        {% endif %}
        <div class="mt-2">
          <a
            href="{% url 'prospects:county_select' prospect_type state.abbreviation %}"
            class="btn btn-outline-success btn-sm"
            title="View Counties"
            onclick="event.stopPropagation();"
            aria-label="View Counties for {{ state.name }}"
          >
            <i class="bi bi-map me-1"></i>View Counties
          </a>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="col-12">
    <div class="alert alert-info">
      No states found with prospect counts.
    </div>
  </div>
  {% endfor %}
</div>

<div class="card mt-4 mb-3">
  <div class="card-body">
    <form method="get" id="state-select-filter-form" class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">{{ filter.form.qualification_status.label }}</label>
        {{ filter.form.qualification_status }}
      </div>
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">{{ filter.form.state.label }}</label>
        {{ filter.form.state }}
      </div>
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">{{ filter.form.county.label }}</label>
        {{ filter.form.county }}
      </div>
      {% for field in filter.form %}
      {% if field.name != "qualification_status" and field.name != "state" and field.name != "county" and field.name != "surplus_amount_range" %}
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">{{ field.label }}</label>
        {{ field }}
      </div>
      {% endif %}
      {% endfor %}
      <div class="col-auto">
        <label class="form-label form-label-sm mb-1">{{ filter.form.surplus_amount_range.label }}</label>
        {{ filter.form.surplus_amount_range }}
      </div>
      <div class="col-auto">
        <button class="btn btn-sm btn-primary" type="submit">
          <i class="bi bi-funnel"></i> Filter
        </button>
        <button id="clear-state-select-filters" class="btn btn-sm btn-outline-secondary ms-1" type="button">Clear</button>
        <a class="btn btn-sm btn-outline-success ms-1" href="?{% for k,v in request.GET.items %}{% if k != 'page' and k != 'export' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}export=excel">
          <i class="bi bi-file-earmark-excel"></i> Export Excel
        </a>
      </div>
    </form>
  </div>
</div>

{% if has_active_filters %}
<div class="row mb-3">
  <div class="col-12 {% if can_view_revenue %}col-md-4{% else %}col-md-6{% endif %}">
    <div class="card h-100">
      <div class="card-body py-2">
        <div class="small text-muted">Filtered Prospects</div>
        <div class="h5 mb-0">{{ filtered_total }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 {% if can_view_revenue %}col-md-4{% else %}col-md-6{% endif %} mt-2 mt-md-0">
    <div class="card h-100">
      <div class="card-body py-2">
        <div class="small text-muted">Filtered Total Surplus</div>
        <div class="h5 mb-0">${{ filtered_surplus|floatformat:2 }}</div>
      </div>
    </div>
  </div>
  {% if can_view_revenue %}
  <div class="col-12 col-md-4 mt-2 mt-md-0">
    <div class="card h-100">
      <div class="card-body py-2">
        <div class="small text-muted">Filtered Total Revenue ({{ ss_revenue_tier }}%)</div>
        <div class="h5 mb-0">${{ filtered_revenue|floatformat:2 }}</div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endif %}

<div class="table-responsive">
  <table class="table table-striped table-hover table-sm align-middle small">
    <thead class="table-dark">
      <tr>
        <th>Case #</th>
        <th class="d-none d-md-table-cell">State</th>
        <th class="d-none d-md-table-cell">County</th>
        <th class="d-none d-lg-table-cell">Source</th>
        <th class="d-none d-lg-table-cell">Parcel ID</th>
        <th>Address</th>
        <th>Auction Date</th>
        <th class="text-end d-none d-lg-table-cell">Surplus</th>
        {% if can_view_revenue %}
        <th class="text-end d-none d-lg-table-cell">SS Rev ({{ ss_revenue_tier }}%)</th>
        <th class="text-end d-none d-lg-table-cell">SS Benefit</th>
        {% endif %}
        <th>QA</th>
        <th class="text-center d-none d-lg-table-cell">AC</th>
        <th class="text-center d-none d-lg-table-cell">TDM</th>
        <th class="d-none d-xl-table-cell">Workflow</th>
        {% if can_view_revenue %}
        <th class="text-end d-none d-lg-table-cell">ARS</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for prospect in prospect_list %}
      <tr>
        <td class="align-middle">
          <a href="{% url 'prospects:detail' prospect.pk %}" class="fw-semibold link-primary link-underline-opacity-0 link-underline-opacity-100-hover">
            {{ prospect.case_number }}
            <i class="bi bi-file-earmark-text ms-1 small"></i>
          </a>
        </td>
        <td class="align-middle d-none d-md-table-cell">{{ prospect.county.state.abbreviation }}</td>
        <td class="align-middle d-none d-md-table-cell">{{ prospect.county.name }}</td>
        <td class="align-middle d-none d-lg-table-cell">{{ prospect.source|default:"<span class=\"text-muted\">-</span>" }}</td>
        <td class="align-middle d-none d-lg-table-cell">
          {% if prospect.parcel_id %}
            <a href="{% if prospect.parcel_url %}{{ prospect.parcel_url }}{% else %}https://apps.miamidadepa.gov/PropertySearch/#/?folio={{ prospect.parcel_id|cut:'-' }}{% endif %}"
               class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover fw-medium"
               target="_blank"
               rel="noopener">
              {{ prospect.parcel_id }}
              <i class="bi bi-globe2 ms-1 small"></i>
            </a>
          {% else %}
            <span class="text-muted">-</span>
          {% endif %}
        </td>
        <td class="align-middle">
          {% if prospect.property_address or prospect.city or prospect.zip_code %}
            <div>{{ prospect.property_address|default:"" }}</div>
            <div class="text-muted small">
              {% if prospect.city %}{{ prospect.city }}{% endif %}{% if prospect.city and prospect.zip_code %}, {% endif %}{% if prospect.zip_code %}{{ prospect.zip_code }}{% endif %}
            </div>
          {% else %}
            <span class="text-muted">-</span>
          {% endif %}
        </td>
        <td class="align-middle">{{ prospect.auction_date|date:"m/d/Y"|default:"-" }}</td>
        <td class="align-middle text-end d-none d-lg-table-cell">{% if prospect.surplus_amount %}${{ prospect.surplus_amount|floatformat:2 }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
        {% if can_view_revenue %}
        <td class="align-middle text-end d-none d-lg-table-cell">{% if prospect.ss_revenue_amount %}${{ prospect.ss_revenue_amount|floatformat:2 }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
        <td class="align-middle text-end d-none d-lg-table-cell">{% if prospect.ss_benefit %}${{ prospect.ss_benefit|floatformat:2 }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
        {% endif %}
        <td class="align-middle text-center">
          {% if prospect.qualification_status == 'qualified' %}
            <span class="badge bg-success">Qualified</span>
          {% elif prospect.qualification_status == 'disqualified' %}
            <span class="badge bg-danger">Disqualified</span>
          {% else %}
            <span class="badge bg-warning text-dark">Pending</span>
          {% endif %}
        </td>
        <td class="align-middle text-center d-none d-lg-table-cell">
          {% if prospect.effective_ac_url %}
            {% if user.profile.is_admin %}
              <a href="{{ prospect.effective_ac_url }}" target="_blank" rel="noopener" class="text-success" title="Open AC URL">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </a>
            {% else %}
              <span class="text-success" title="AC URL available">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </span>
            {% endif %}
          {% else %}
            <span class="text-danger" title="AC URL not available">
              <i class="bi bi-x-circle-fill fs-5"></i>
            </span>
          {% endif %}
        </td>
        <td class="align-middle text-center d-none d-lg-table-cell">
          {% if prospect.effective_tdm_url %}
            {% if user.profile.is_admin %}
              <a href="{{ prospect.effective_tdm_url }}" target="_blank" rel="noopener" class="text-success" title="Open TDM URL">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </a>
            {% else %}
              <span class="text-success" title="TDM URL available">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </span>
            {% endif %}
          {% else %}
            <span class="text-danger" title="TDM URL not available">
              <i class="bi bi-x-circle-fill fs-5"></i>
            </span>
          {% endif %}
        </td>
        <td class="align-middle text-center d-none d-xl-table-cell">
          {% if prospect.workflow_status == 'new' %}
            <span class="badge bg-secondary">New</span>
          {% elif prospect.workflow_status == 'assigned' %}
            <span class="badge bg-primary">Assigned</span>
          {% elif prospect.workflow_status == 'researching' %}
            <span class="badge bg-info text-dark">Researching</span>
          {% elif prospect.workflow_status == 'skip_tracing' %}
            <span class="badge bg-warning text-dark">Skip Trace</span>
          {% elif prospect.workflow_status == 'contacting' %}
            <span class="badge bg-warning">Contacting</span>
          {% elif prospect.workflow_status == 'contract_sent' %}
            <span class="badge bg-success">Contract Sent</span>
          {% elif prospect.workflow_status == 'converted' %}
            <span class="badge bg-success">Converted</span>
          {% elif prospect.workflow_status == 'dead' %}
            <span class="badge bg-danger">Dead</span>
          {% else %}
            <span class="badge bg-light text-dark">{{ prospect.workflow_status }}</span>
          {% endif %}
        </td>
        {% if can_view_revenue %}
        <td class="align-middle text-end d-none d-lg-table-cell">
          {% if prospect.assigned_to %}
            {% if prospect.ars_tier_percent and prospect.ars_amount %}
            <div class="small">{{ prospect.ars_tier_percent }}%</div>
            <div class="fw-semibold">${{ prospect.ars_amount|floatformat:2 }}</div>
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          {% else %}
            <span class="text-muted small">N/A</span>
          {% endif %}
        </td>
        {% endif %}
      </tr>
      {% empty %}
      <tr>
        <td colspan="{% if can_view_revenue %}15{% else %}12{% endif %}" class="text-center text-muted py-4">No prospects found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% include "includes/pagination.html" %}

<script>
  (function () {
    const input = document.getElementById("stateSearchInput");
    const items = Array.from(document.querySelectorAll("#stateCardsGrid .searchable-item"));
    if (input && items.length) {
      input.addEventListener("input", function () {
        const q = input.value.trim().toLowerCase();
        items.forEach(function (item) {
          const text = item.getAttribute("data-search-text") || "";
          item.style.display = text.includes(q) ? "" : "none";
        });
      });
    }

    const clearBtn = document.getElementById("clear-state-select-filters");
    const filterForm = document.getElementById("state-select-filter-form");
    if (clearBtn && filterForm) {
      clearBtn.addEventListener("click", function () {
        Array.from(filterForm.elements).forEach(function (el) {
          if (!el.name || el.disabled) return;
          if (el.tagName === "SELECT") {
            el.value = "";
          } else if (el.type === "checkbox" || el.type === "radio") {
            el.checked = false;
          } else if (el.type !== "submit" && el.type !== "button") {
            el.value = "";
          }
        });
        filterForm.submit();
      });
    }
  })();
</script>
{% endblock %}





