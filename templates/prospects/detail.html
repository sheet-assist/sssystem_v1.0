
{% extends "base.html" %}
{% load static %}

{% block title %}Prospect {{ object.case_number }}{% endblock %}

{% block content %}
{# Breadcrumb #}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'prospects:type_select' %}">Prospects</a></li>
    <li class="breadcrumb-item">
      <a href="{% url 'prospects:state_select' object.prospect_type %}">{{ object.prospect_type }}</a>
    </li>
    <li class="breadcrumb-item">
      <a href="{% url 'prospects:county_select' object.prospect_type object.county.state.abbreviation %}">{{ object.county.state.abbreviation }}</a>
    </li>
    <li class="breadcrumb-item">
      <a href="{% url 'prospects:list' object.prospect_type object.county.state.abbreviation object.county.slug %}">{{ object.county.name }}</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">{{ object.case_number }}</li>
  </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-0">{{ object.case_number }}</h2>
    <div class="text-muted small">Type: {{ object.get_prospect_type_display }}</div>
  </div>
  <span class="badge fs-6
    {% if object.workflow_status == 'new' %}bg-secondary
    {% elif object.workflow_status == 'assigned' %}bg-primary
    {% elif object.workflow_status == 'researching' %}bg-info text-dark
    {% elif object.workflow_status == 'skip_tracing' %}bg-warning text-dark
    {% elif object.workflow_status == 'contacting' %}bg-warning
    {% elif object.workflow_status == 'contract_sent' %}bg-success
    {% elif object.workflow_status == 'converted' %}bg-success
    {% elif object.workflow_status == 'dead' %}bg-danger
    {% else %}bg-light text-dark{% endif %}">
    {{ object.get_workflow_status_display }}
  </span>
</div>

{# Action Buttons #}
<div class="mb-4">
  <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="if (window.history.length > 1) { window.history.back(); } else { window.location.href='{% url 'prospects:type_select' %}'; }">
    <i class="bi bi-arrow-left"></i> Back
  </button>
  <a href="{% url 'prospects:assign' object.pk %}" class="btn btn-outline-primary btn-sm me-1">
    <i class="bi bi-person-plus"></i> Assign
  </a>
  <a href="{% url 'prospects:note_add' object.pk %}" class="btn btn-outline-secondary btn-sm me-1">
    <i class="bi bi-sticky"></i> Add Note
  </a>
  <a href="{% url 'prospects:research' object.pk %}" class="btn btn-outline-info btn-sm me-1">
    <i class="bi bi-search"></i> Research
  </a>
  <a href="{% url 'prospects:transition' object.pk %}" class="btn btn-outline-warning btn-sm me-1">
    <i class="bi bi-arrow-left-right"></i> Transition
  </a>
  <a href="{% url 'prospects:history' object.pk %}" class="btn btn-outline-dark btn-sm me-1">
    <i class="bi bi-clock-history"></i> History
  </a>

  <a href="{% url 'prospects:documents_page_v2' object.pk %}" target="_blank" rel="noopener" id="openDigitalFolderV2Btn" class="btn btn-outline-success btn-sm me-1">
    <i class="bi bi-folder2-open"></i> Digital Folder
    {% if object.documents.count %}
    <span class="badge rounded-pill bg-success ms-1">{{ object.documents.count }}</span>
    {% endif %}
  </a>

  {% if user.profile.is_admin %}
  <button
    type="button"
    class="btn btn-outline-danger btn-sm me-1"
    data-bs-toggle="modal"
    data-bs-target="#confirmDeleteProspectModal"
    data-delete-url="{% url 'prospects:delete' object.pk %}"
    data-case-number="{{ object.case_number }}"
    data-next-url="{% url 'prospects:list_by_type' object.prospect_type %}"
  >
    <i class="bi bi-trash"></i> Delete
  </button>
  {% endif %}
  <a href="{% url 'prospects:autodialer' object.pk %}" class="btn btn-outline-secondary btn-sm me-1">
    <i class="bi bi-telephone"></i> Autodialer
  </a>
  <a href="{% url 'prospects:email' object.pk %}" class="btn btn-outline-secondary btn-sm me-1">
    <i class="bi bi-envelope"></i> Email
  </a>
  {% if object.workflow_status == 'contract_sent' or object.workflow_status == 'converted' %}
  <a href="{% url 'cases:convert' object.pk %}" class="btn btn-success btn-sm">
    <i class="bi bi-box-arrow-in-right"></i> Convert to Case
  </a>
  {% endif %}
</div>



<div class="row g-3 align-items-start">

{# ── Timeline Sidebar (right, sticky) ── #}
<div class="col-lg-3 order-lg-last">
  <div class="card" style="position:sticky;top:66px;max-height:calc(100vh - 82px);overflow-y:auto;">
    <div class="card-header fw-semibold py-2" style="font-size:.85rem;">
      <i class="bi bi-diagram-3 me-1"></i> Lifecycle Timeline
    </div>
    <div class="card-body p-2">
      {% include "includes/_lifecycle_timeline.html" %}
    </div>
  </div>
</div>

{# ── Main Content ── #}
<div class="col-lg-9 order-lg-first">
<div class="row">
  {# Left Column #}
  <div class="col-lg-8">

    {# Identity Card #}
    <div class="card mb-3">
      <div class="card-header fw-semibold"><i class="bi bi-card-heading me-1"></i> Identity</div>
      <div class="card-body">
        <div class="row">
          <div class="col-sm-6">
            <p class="mb-1"><strong>Type:</strong> {{ object.get_prospect_type_display }}</p>
            <p class="mb-1"><strong>Case #:</strong> {{ object.case_number }}</p>
          </div>
          <div class="col-sm-6">
            <p class="mb-1"><strong>Case Style:</strong> {{ object.case_style|default:"-" }}</p>
            <p class="mb-1"><strong>Auction Item:</strong> {{ object.auction_item_number|default:"-" }}</p>
          </div>
        </div>
      </div>
    </div>

    {# Location Card #}
    <div class="card mb-3">
      <div class="card-header fw-semibold"><i class="bi bi-geo-alt me-1"></i> Location</div>
      <div class="card-body">
        <div class="row">
          <div class="col-sm-6">
            <p class="mb-1"><strong>County:</strong> {{ object.county }}</p>
            <p class="mb-1"><strong>Address:</strong> {{ object.property_address|default:"-" }}</p>
            <p class="mb-1"><strong>City:</strong> {{ object.city|default:"-" }}</p>
          </div>
          <div class="col-sm-6">
            <p class="mb-1"><strong>State:</strong> {{ object.state|default:"-" }}</p>
            <p class="mb-1"><strong>Zip:</strong> {{ object.zip_code|default:"-" }}</p>
            <p class="mb-1"><strong>Parcel ID:</strong>
              {% if object.parcel_id %}
                <a href="{% if object.parcel_url %}{{ object.parcel_url }}{% else %}https://apps.miamidadepa.gov/PropertySearch/#/?folio={{ object.parcel_id|cut:'-' }}{% endif %}"
                   target="_blank"
                   rel="noopener noreferrer">{{ object.parcel_id }}</a>
              {% else %}
                -
              {% endif %}
            </p>
          </div>
        </div>
      </div>
    </div>

    {# Financial Card #}
    <div class="card mb-3">
      <div class="card-header fw-semibold"><i class="bi bi-currency-dollar me-1"></i> Financial</div>
      <div class="card-body">
        <div class="row">
          <div class="col-sm-6">
            <p class="mb-1"><strong>Final Judgment:</strong> {% if object.final_judgment_amount %}${{ object.final_judgment_amount|floatformat:2 }}{% else %}-{% endif %}</p>
            <p class="mb-1"><strong>Opening Bid:</strong> {% if object.opening_bid %}${{ object.opening_bid|floatformat:2 }}{% else %}-{% endif %}</p>
            <p class="mb-1"><strong>Plaintiff Max Bid:</strong> {% if object.plaintiff_max_bid %}${{ object.plaintiff_max_bid|floatformat:2 }}{% else %}-{% endif %}</p>
          </div>
          <div class="col-sm-6">
            <p class="mb-1"><strong>Assessed Value:</strong> {% if object.assessed_value %}${{ object.assessed_value|floatformat:2 }}{% else %}-{% endif %}</p>
            <p class="mb-1"><strong>Surplus:</strong> {% if object.surplus_amount %}${{ object.surplus_amount|floatformat:2 }}{% else %}-{% endif %}</p>
            <p class="mb-1"><strong>Sale Amount:</strong> {% if object.sale_amount %}${{ object.sale_amount|floatformat:2 }}{% else %}-{% endif %}</p>
            <p class="mb-1"><strong>Sold To:</strong> {{ object.sold_to|default:"-" }}</p>
          </div>
        </div>
      </div>
    </div>

    {# Parties Card #}
    <div class="card mb-3">
      <div class="card-header fw-semibold"><i class="bi bi-people me-1"></i> Parties</div>
      <div class="card-body">
        <div class="row">
          <div class="col-sm-6">
            <p class="mb-1"><strong>Plaintiff:</strong> {{ object.plaintiff_name|default:"-" }}</p>
          </div>
          <div class="col-sm-6">
            <p class="mb-1"><strong>Defendant:</strong> {{ object.defendant_name|default:"-" }}</p>
          </div>
        </div>
      </div>
    </div>

    {# Notes Card #}
    <div class="card mb-3">
      <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-sticky me-1"></i> Notes</span>
        <a href="{% url 'prospects:note_add' object.pk %}" class="btn btn-sm btn-outline-primary">Add Note</a>
      </div>
      <div class="card-body">
        {% for note in object.notes.all %}
        <div class="border-bottom pb-2 mb-2{% if forloop.last %} border-bottom-0 pb-0 mb-0{% endif %}">
          <div class="d-flex justify-content-between">
            <strong>{{ note.author.get_full_name|default:note.author.username }}</strong>
            <small class="text-muted">{{ note.created_at|date:"m/d/Y H:i" }}</small>
          </div>
          <p class="mb-0 mt-1">{{ note.content|linebreaksbr }}</p>
        </div>
        {% empty %}
        <p class="text-muted mb-0">No notes yet.</p>
        {% endfor %}
      </div>
    </div>

  </div>

  {# Right Column #}
  <div class="col-lg-4">

    {# Schedule Card #}
    <div class="card mb-3">
      <div class="card-header fw-semibold"><i class="bi bi-calendar-event me-1"></i> Schedule</div>
      <div class="card-body">
        <p class="mb-1"><strong>Auction Date:</strong> {{ object.auction_date|date:"m/d/Y"|default:"-" }}</p>
        <p class="mb-1"><strong>Auction Time:</strong> {{ object.auction_time|time:"h:i A"|default:"-" }}</p>
        <p class="mb-1"><strong>Status:</strong> {{ object.get_auction_status_display|default:"-" }}</p>
      </div>
    </div>

    {# Status Card #}
    <div class="card mb-3">
      <div class="card-header fw-semibold"><i class="bi bi-flag me-1"></i> Status</div>
      <div class="card-body">
        <p class="mb-1"><strong>Qualification:</strong>
          {% if object.qualification_status == 'qualified' %}
            <span class="badge bg-success">Qualified</span>
          {% elif object.qualification_status == 'disqualified' %}
            <span class="badge bg-danger">Disqualified</span>
          {% else %}
            <span class="badge bg-warning text-dark">Pending</span>
          {% endif %}
        </p>
        <p class="mb-1"><strong>AC:</strong>
          {% if object.ack_url %}
            {% if user.profile.is_admin %}
              <a href="{{ object.ack_url }}" target="_blank" rel="noopener" class="text-success" title="Open AC URL">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </a>
            {% else %}
              <span class="text-success" title="AC URL available">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </span>
            {% endif %}
          {% else %}
            <span class="text-danger" title="AC URL not available">
              <i class="bi bi-x-circle-fill fs-5"></i>
            </span>
          {% endif %}
        </p>
        <p class="mb-1"><strong>TDM:</strong>
          {% if object.tdm_url %}
            {% if user.profile.is_admin %}
              <a href="{{ object.tdm_url }}" target="_blank" rel="noopener" class="text-success" title="Open TDM URL">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </a>
            {% else %}
              <span class="text-success" title="TDM URL available">
                <i class="bi bi-check-circle-fill fs-5"></i>
              </span>
            {% endif %}
          {% else %}
            <span class="text-danger" title="TDM URL not available">
              <i class="bi bi-x-circle-fill fs-5"></i>
            </span>
          {% endif %}
        </p>
        <p class="mb-1"><strong>Workflow:</strong> {{ object.get_workflow_status_display }}</p>
        <p class="mb-1"><strong>Assigned To:</strong>
          {% if object.assigned_to %}
            {{ object.assigned_to.get_full_name|default:object.assigned_to.username }}
          {% else %}
            <span class="text-muted">Unassigned</span>
          {% endif %}
        </p>
        {% if object.assigned_by %}
        <p class="mb-1"><strong>Assigned By:</strong> {{ object.assigned_by.get_full_name|default:object.assigned_by.username }}</p>
        {% endif %}
        {% if object.assigned_at %}
        <p class="mb-1"><strong>Assigned At:</strong> {{ object.assigned_at|date:"m/d/Y H:i" }}</p>
        {% endif %}
      </div>
    </div>

    {# Research Card #}
    <div class="card mb-3">
      <div class="card-header fw-semibold"><i class="bi bi-clipboard-check me-1"></i> Research</div>
      <div class="card-body">
        <p class="mb-1">
          <i class="bi {% if object.lien_check_done %}bi-check-circle-fill text-success{% else %}bi-circle text-muted{% endif %} me-1"></i>
          Lien Check
        </p>
        {% if object.lien_check_notes %}
        <p class="mb-1 ms-4 small text-muted">{{ object.lien_check_notes|truncatewords:20 }}</p>
        {% endif %}
        <p class="mb-1">
          <i class="bi {% if object.surplus_verified %}bi-check-circle-fill text-success{% else %}bi-circle text-muted{% endif %} me-1"></i>
          Surplus Verified
        </p>
        <p class="mb-1">
          <i class="bi {% if object.documents_verified %}bi-check-circle-fill text-success{% else %}bi-circle text-muted{% endif %} me-1"></i>
          Documents Verified
        </p>
      </div>
    </div>

    {# Contact Card #}
    <div class="card mb-3">
      <div class="card-header fw-semibold"><i class="bi bi-telephone me-1"></i> Contact</div>
      <div class="card-body">
        <p class="mb-1">
          <i class="bi {% if object.skip_trace_done %}bi-check-circle-fill text-success{% else %}bi-circle text-muted{% endif %} me-1"></i>
          Skip Trace: {% if object.skip_trace_done %}Done{% else %}Pending{% endif %}
        </p>
        <p class="mb-1"><strong>Contact Info:</strong></p>
        <p class="mb-1">{{ object.owner_contact_info|default:"-"|linebreaksbr }}</p>
        <p class="mb-0"><strong>Contact Attempts:</strong> {{ object.contact_attempts }}</p>
      </div>
    </div>

  </div>
</div>{# /inner row #}

{% if user.profile.is_admin %}
<div class="modal fade" id="confirmDeleteProspectModal" tabindex="-1" aria-labelledby="confirmDeleteProspectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteProspectModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Delete prospect <strong id="deleteProspectCaseRef">{{ object.case_number }}</strong>? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteProspectForm" method="post" action="{% url 'prospects:delete' object.pk %}" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="next" id="deleteProspectNext" value="{% url 'prospects:list_by_type' object.prospect_type %}">
          <button type="submit" class="btn btn-danger btn-sm">
            <i class="bi bi-trash"></i> Delete
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("confirmDeleteProspectModal");
    if (!modal) return;

    modal.addEventListener("show.bs.modal", function (event) {
      const trigger = event.relatedTarget;
      if (!trigger) return;

      const action = trigger.getAttribute("data-delete-url") || "";
      const caseNumber = trigger.getAttribute("data-case-number") || "-";
      const nextUrl = trigger.getAttribute("data-next-url") || "";

      const form = document.getElementById("deleteProspectForm");
      const caseRef = document.getElementById("deleteProspectCaseRef");
      const nextInput = document.getElementById("deleteProspectNext");

      if (form) form.setAttribute("action", action);
      if (caseRef) caseRef.textContent = caseNumber;
      if (nextInput) nextInput.value = nextUrl;
    });
  });
</script>
{% endif %}

{# Recent Activity #}
<div class="card mt-3">
  <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
    <span><i class="bi bi-clock-history me-1"></i> Recent Activity</span>
    <a href="{% url 'prospects:history' object.pk %}" class="btn btn-sm btn-outline-dark">View All</a>
  </div>
  <div class="card-body p-0">
    <table class="table table-sm mb-0">
      <tbody>
        {% for log in object.action_logs.all|slice:":5" %}
          <td class="text-muted" style="width:160px;">{{ log.created_at|date:"m/d/Y H:i" }}</td>
          <td><span class="badge bg-secondary">{{ log.get_action_type_display }}</span></td>
          <td>{{ log.description|default:"-" }}</td>
          <td class="text-end text-muted">{% if log.user %}{{ log.user.get_full_name|default:log.user.username }}{% else %}System{% endif %}</td>
        </tr>
        {% empty %}
        <tr><td class="text-center text-muted py-3" colspan="4">No activity yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{# Rule Notes Table #}
<div class="card mt-3">
  <div class="card-header fw-semibold">
    <span><i class="bi bi-exclamation-octagon me-1"></i> Rule Notes</span>
  </div>
  <div class="card-body p-0">
    <table class="table table-sm mb-0">
      <thead>
        <tr>
          <th style="width:160px;">Date</th>
          <th style="width:140px;">Rule</th>
          <th style="width:120px;">Result</th>
          <th>Note</th>
          <th style="width:130px;">Source</th>
          <th class="text-end" style="width:170px;">By</th>
        </tr>
      </thead>
      <tbody>
        {% for note in object.rule_notes.all %}
        <tr>
          <td class="text-muted">{{ note.created_at|date:"m/d/Y H:i" }}</td>
          <td>
            {% if note.rule %}
            <a href="{% url 'settings_app:criteria_edit' note.rule.pk %}"
               class="btn btn-outline-primary btn-sm w-100"
               target="_blank" rel="noopener">
              <i class="bi bi-box-arrow-up-right"></i>
              {{ note.rule_name|default:note.rule.name }}
            </a>
            {% else %}
            <span class="text-muted fw-semibold">{{ note.rule_name|default:"Rule" }}</span>
            {% endif %}
          </td>
          <td>
            <span class="badge {% if note.decision == 'qualified' %}bg-success{% else %}bg-danger{% endif %}">{{ note.get_decision_display }}</span>
          </td>
          <td>{{ note.note|default:"-" }}</td>
          <td><span class="badge bg-light text-dark border text-uppercase">{{ note.get_source_display }}</span></td>
          <td class="text-end text-muted">{% if note.created_by %}{{ note.created_by.get_full_name|default:note.created_by.username }}{% else %}System{% endif %}</td>
        </tr>
        {% empty %}
        <tr><td class="text-center text-muted py-3" colspan="6">No rule notes yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

</div>{# /col-lg-9 main content #}
</div>{# /outer row g-3 #}

{% endblock %}


