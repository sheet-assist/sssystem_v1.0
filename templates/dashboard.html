{% extends "base.html" %}

{% block title %}Dashboard - SSSys{% endblock %}

{% block content %}
<h2 class="mb-4">Dashboard</h2>

{# --- Top Stats Row --- #}
<div class="row row-cols-1 row-cols-sm-2 row-cols-xl-5 g-3 mb-4">
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="card-subtitle text-muted mb-2">Total Prospects</h6>
        <p class="fs-3 fw-semibold mb-0">{{ total_prospects }}</p>
      </div>
      <div class="card-footer bg-transparent border-0 pt-0">
        <small>
          <span class="text-success">{{ qualified_count }} qualified</span> /
          <span class="text-danger">{{ disqualified_count }} disqualified</span> /
          <span class="text-warning">{{ pending_count }} pending</span>
        </small>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="card-subtitle text-muted mb-2">Active Cases</h6>
        <p class="fs-3 fw-semibold mb-0">{{ active_cases }}</p>
      </div>
      <div class="card-footer bg-transparent border-0 pt-0">
        <small>{{ total_cases }} total &middot; <span class="text-success">{{ closed_won }} won</span> &middot; <span class="text-danger">{{ closed_lost }} lost</span></small>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="card-subtitle text-muted mb-2">Conversion Rate</h6>
        <p class="fs-3 fw-semibold mb-0">{{ conversion_rate }}%</p>
      </div>
      <div class="card-footer bg-transparent border-0 pt-0">
        <small>{{ converted_count }} of {{ total_prospects }} prospects converted</small>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="card-subtitle text-muted mb-2">Touched / Untouched</h6>
        <p class="fs-3 fw-semibold mb-0">{{ touched_count }} / {{ untouched_count }}</p>
      </div>
      <div class="card-footer bg-transparent border-0 pt-0">
        <small>{{ untouched_count }} prospects still at "New"</small>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="card-subtitle text-muted mb-2">Total Revenue  ({{ ss_revenue_tier }}%)</h6>
        <p class="fs-4 fw-semibold mb-0">${{ total_revenue |floatformat:2 }}</p>
      </div>
      <div class="card-footer bg-transparent border-0 pt-0">
        <small>Qualified Surplus Amount : <span class="text-success">${{ qualified_surplus_amount|floatformat:2 }}</span></small>
      </div>
    </div>
  </div>
</div>

{# --- Daily Qualified Trend --- #}
<div class="card mb-4">
  <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
    <strong>Daily Qualified Count</strong>
    <div class="d-flex align-items-center gap-2">
      <div class="btn-group btn-group-sm" role="group" aria-label="Daily Qualified Period">
        <button type="button" class="btn btn-outline-success active" data-dq-mode="30days">30 Days</button>
        <button type="button" class="btn btn-outline-success" data-dq-mode="month">Month</button>
      </div>
      <div class="d-flex align-items-center gap-1">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="dqPrev" title="Previous">&laquo;</button>
        <span class="badge bg-light text-dark border px-2 py-1" id="dqPeriodLabel" style="min-width:180px;text-align:center;font-size:.82rem;">
          Loadingâ€¦
        </span>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="dqNext" title="Next">&raquo;</button>
      </div>
    </div>
  </div>
  <div class="card-body py-2">
    <div class="position-relative" style="height: 180px;">
      <canvas id="dailyQualifiedChart"></canvas>
    </div>
  </div>
</div>

{# --- Prospect Conversion Chart --- #}
<div class="card mb-4">
  <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
    <strong>Prospect Conversion % (Assigned to Converted by User)</strong>
    <div class="btn-group btn-group-sm" role="group" aria-label="Prospect Conversion Period">
      <button type="button" class="btn btn-outline-success active" data-kpi-period-prospect="daily">Daily</button>
      <button type="button" class="btn btn-outline-success" data-kpi-period-prospect="monthly">Monthly</button>
      <button type="button" class="btn btn-outline-success" data-kpi-period-prospect="yearly">Yearly</button>
    </div>
  </div>
  <div class="card-body">
    <div class="position-relative" style="height: 320px;">
      <canvas id="prospectConversionChart"></canvas>
    </div>
    <small class="text-muted d-block mt-2">
      Conversion % = converted prospects / assigned prospects in period, grouped by user.
    </small>
    <div class="table-responsive mt-3">
      <table class="table table-sm table-striped mb-0" id="prospectConversionTable">
        <thead>
          <tr>
            <th>Period</th>
            <th>User</th>
            <th class="text-end">Assigned</th>
            <th class="text-end">Converted</th>
            <th class="text-end">Conversion %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

{# --- Pipeline Row --- #}
<div class="card mb-4">
  <div class="card-header"><strong>Prospect Pipeline</strong></div>
  <div class="card-body">
    <div class="row text-center">
      {% for label, count in pipeline %}
      <div class="col">
        <div class="border rounded p-2">
          <small class="text-muted d-block">{{ label }}</small>
          <span class="fs-4 fw-bold">{{ count }}</span>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<div class="row">
  {# --- Left: Recent Activity --- #}
  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-header"><strong>Recent Activity</strong></div>
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <tbody>
            {% for item in recent_activity %}
            <tr>
              <td style="width:140px;"><small class="text-muted">{{ item.time|date:"M d, H:i" }}</small></td>
              <td>
                {% if item.type == "prospect" %}
                  <span class="badge bg-info">Prospect</span>
                {% else %}
                  <span class="badge bg-primary">Case</span>
                {% endif %}
              </td>
              <td><a href="{{ item.url }}">{{ item.ref }}</a></td>
              <td>{{ item.action }}</td>
              <td class="text-muted">{{ item.user.username|default:"System" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="text-center text-muted py-3">No activity yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# --- Right: Quick Actions & Scraper --- #}
  <div class="col-lg-4">
    {# Quick Actions #}
    <div class="card mb-4">
      <div class="card-header"><strong>Quick Actions</strong></div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{% url 'prospects:type_select' %}" class="btn btn-outline-primary btn-sm">Browse Prospects</a>
          <a href="{% url 'cases:list' %}" class="btn btn-outline-secondary btn-sm">View Cases</a>
          {% if is_admin %}
          <a href="{% url 'scraper:job_create' %}" class="btn btn-outline-success btn-sm">New Scrape Job</a>
          <a href="{% url 'settings_app:criteria_list' %}" class="btn btn-outline-warning btn-sm">Filter Criteria</a>
          {% endif %}
        </div>
      </div>
    </div>

    {# Scraper Status (admin only) #}
    {% if is_admin %}
    <div class="card mb-4">
      <div class="card-header"><strong>Scraper Status</strong></div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-7">Total Jobs</dt>
          <dd class="col-5">{{ total_scrape_jobs }}</dd>
          <dt class="col-7">Running</dt>
          <dd class="col-5">
            {% if running_jobs > 0 %}
              <span class="badge bg-warning text-dark">{{ running_jobs }}</span>
            {% else %}
              0
            {% endif %}
          </dd>
          <dt class="col-7">Last Job</dt>
          <dd class="col-5">
            {% if last_scrape_job %}
              <a href="{% url 'scraper:job_detail' last_scrape_job.pk %}">
                #{{ last_scrape_job.pk }}
                {% if last_scrape_job.status == "completed" %}<span class="badge bg-success">OK</span>
                {% elif last_scrape_job.status == "failed" %}<span class="badge bg-danger">Failed</span>
                {% elif last_scrape_job.status == "running" %}<span class="badge bg-warning text-dark">Running</span>
                {% else %}<span class="badge bg-secondary">Pending</span>{% endif %}
              </a>
            {% else %}
              -
            {% endif %}
          </dd>
        </dl>
        <a href="{% url 'scraper:dashboard' %}" class="btn btn-sm btn-outline-dark mt-2 w-100">Go to Scraper</a>
      </div>
    </div>
    {% endif %}

    {# My Stats (non-admin) #}
    {% if not is_admin %}
    <div class="card mb-4">
      <div class="card-header"><strong>My Work</strong></div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-8">My Prospects</dt>
          <dd class="col-4">{{ my_prospects }}</dd>
          <dt class="col-8">My Cases</dt>
          <dd class="col-4">{{ my_cases }}</dd>
        </dl>
        <a href="{% url 'prospects:my_prospects' %}" class="btn btn-sm btn-outline-primary mt-2 w-100">View My Prospects</a>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
{{ daily_qualified_chart|json_script:"daily-qualified-chart-data" }}
{{ prospect_conversion_kpi|json_script:"prospect-conversion-kpi-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function() {
    if (typeof Chart === "undefined") return;

    const palette = [
      "#0d6efd", "#198754", "#dc3545", "#fd7e14", "#6f42c1", "#20c997", "#6610f2", "#0dcaf0"
    ];

    const withColors = (datasets) => datasets.map((dataset, index) => ({
      ...dataset,
      borderColor: dataset.borderColor || palette[index % palette.length],
      backgroundColor: dataset.backgroundColor || palette[index % palette.length],
      tension: dataset.tension ?? 0.25,
      fill: dataset.fill ?? false,
      pointRadius: dataset.pointRadius ?? 3
    }));

    const dailyPayloadEl = document.getElementById("daily-qualified-chart-data");
    const dailyChartEl = document.getElementById("dailyQualifiedChart");
    if (dailyPayloadEl && dailyChartEl) {
      const dailyData = JSON.parse(dailyPayloadEl.textContent || "{}");
      if (window.dailyQualifiedChart && typeof window.dailyQualifiedChart.destroy === "function") {
        window.dailyQualifiedChart.destroy();
      }
      const qualifiedBarLabelPlugin = {
        id: "qualifiedBarLabelPlugin",
        afterDatasetsDraw(chart) {
          const ctx = chart.ctx;
          const qualifiedMeta = chart.getDatasetMeta(0);
          const qualifiedDataset = chart.data.datasets[0];
          if (!qualifiedMeta || !qualifiedDataset) return;

          ctx.save();
          ctx.fillStyle = "#146c43";
          ctx.font = "11px sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "bottom";

          qualifiedMeta.data.forEach((bar, index) => {
            const value = qualifiedDataset.data?.[index];
            if (value === null || value === undefined) return;
            ctx.fillText(String(value), bar.x, bar.y - 4);
          });
          ctx.restore();
        },
      };
      window.dailyQualifiedChart = new Chart(dailyChartEl, {
        type: "bar",
        plugins: [qualifiedBarLabelPlugin],
        data: {
          labels: dailyData.labels || [],
          datasets: [{
            label: "Qualified Count",
            data: dailyData.qualified_counts || [],
            backgroundColor: "rgba(25, 135, 84, 0.75)",
            borderColor: "#198754",
            borderWidth: 1,
            maxBarThickness: 14,
            barPercentage: 0.5,
            categoryPercentage: 0.7,
          }, {
            label: "Disqualified Count",
            data: dailyData.disqualified_counts || [],
            backgroundColor: "rgba(220, 53, 69, 0.75)",
            borderColor: "#dc3545",
            borderWidth: 1,
            maxBarThickness: 14,
            barPercentage: 0.5,
            categoryPercentage: 0.7,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 },
              title: { display: true, text: "Qualified Count" },
            },
            x: {
              title: { display: true, text: "Date" },
            },
          },
        },
      });

      // --- Daily Qualified chart navigation ---
      const dqPeriodLabel = document.getElementById("dqPeriodLabel");
      const dqPrevBtn = document.getElementById("dqPrev");
      const dqNextBtn = document.getElementById("dqNext");
      const dqModeButtons = document.querySelectorAll("[data-dq-mode]");
      const DQ_API_URL = "{% url 'dashboard:daily_qualified_api' %}";

      // State
      let dqMode = "30days";
      let dqStart = dailyData.labels?.[0] || null;
      let dqEnd = dailyData.labels?.[dailyData.labels.length - 1] || null;

      // Derive initial period label
      function formatLabel(start, end) {
        const opts = { month: "short", day: "numeric", year: "numeric" };
        const s = new Date(start + "T00:00:00");
        const e = new Date(end + "T00:00:00");
        return s.toLocaleDateString("en-US", opts) + " \u2013 " + e.toLocaleDateString("en-US", opts);
      }
      if (dqStart && dqEnd) {
        dqPeriodLabel.textContent = formatLabel(dqStart, dqEnd);
      }
      dqNextBtn.disabled = true; // initial load is latest

      function updateDqChart(data) {
        const chart = window.dailyQualifiedChart;
        chart.data.labels = data.labels || [];
        chart.data.datasets[0].data = data.qualified_counts || [];
        chart.data.datasets[1].data = data.disqualified_counts || [];
        chart.update();
        dqStart = data.start;
        dqEnd = data.end;
        dqPeriodLabel.textContent = data.period_label || "";
        dqNextBtn.disabled = !!data.is_latest;
      }

      async function fetchDq(params) {
        const qs = new URLSearchParams(params).toString();
        try {
          const resp = await fetch(`${DQ_API_URL}?${qs}`);
          if (!resp.ok) return;
          const data = await resp.json();
          updateDqChart(data);
        } catch (e) {
          console.error("Failed to fetch daily qualified data", e);
        }
      }

      // Mode toggle
      dqModeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          dqModeButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          dqMode = btn.dataset.dqMode;
          // Fetch latest for chosen mode
          if (dqMode === "month") {
            const today = new Date();
            fetchDq({ mode: "month", year: today.getFullYear(), month: today.getMonth() + 1 });
          } else {
            fetchDq({ mode: "30days" });
          }
        });
      });

      // Helper to shift dates
      function addDays(dateStr, days) {
        const d = new Date(dateStr + "T00:00:00");
        d.setDate(d.getDate() + days);
        return d.toISOString().slice(0, 10);
      }

      function shiftMonth(dateStr, delta) {
        const d = new Date(dateStr + "T00:00:00");
        d.setMonth(d.getMonth() + delta);
        return { year: d.getFullYear(), month: d.getMonth() + 1 };
      }

      dqPrevBtn.addEventListener("click", () => {
        if (dqMode === "month") {
          const prev = shiftMonth(dqStart, -1);
          fetchDq({ mode: "month", year: prev.year, month: prev.month });
        } else {
          const newEnd = addDays(dqStart, -1);
          const newStart = addDays(newEnd, -29);
          fetchDq({ mode: "30days", start: newStart, end: newEnd });
        }
      });

      dqNextBtn.addEventListener("click", () => {
        if (dqMode === "month") {
          const nxt = shiftMonth(dqStart, 1);
          fetchDq({ mode: "month", year: nxt.year, month: nxt.month });
        } else {
          const newStart = addDays(dqEnd, 1);
          const newEnd = addDays(newStart, 29);
          fetchDq({ mode: "30days", start: newStart, end: newEnd });
        }
      });
    }

    const renderTable = (tableBody, periodData, mode) => {
      if (!tableBody) return;
      const labels = periodData.labels || [];
      const datasets = periodData.datasets || [];
      let rowsHtml = "";

      labels.forEach((label, labelIndex) => {
        datasets.forEach((dataset) => {
          const value = Number(dataset.data?.[labelIndex] ?? 0);
          if (mode === "case_rate" || mode === "prospect_rate") {
            const details = (periodData.details || {})[dataset.label] || {};
            const detailRow = details[label] || { assigned: 0, converted: 0, conversion_rate: value };
            rowsHtml += `
              <tr>
                <td>${label}</td>
                <td>${dataset.label}</td>
                <td class="text-end">${Math.round(detailRow.assigned || 0)}</td>
                <td class="text-end">${Math.round(detailRow.converted || 0)}</td>
                <td class="text-end">${Number(detailRow.conversion_rate || value).toFixed(1)}%</td>
              </tr>
            `;
          } else {
            const renderedValue = mode === "percent" ? `${value.toFixed(1)}%` : `${Math.round(value)}`;
            rowsHtml += `
              <tr>
                <td>${label}</td>
                <td>${dataset.label}</td>
                <td class="text-end">${renderedValue}</td>
              </tr>
            `;
          }
        });
      });

      if (!rowsHtml) {
        const colspan = (mode === "case_rate" || mode === "prospect_rate") ? 5 : 3;
        rowsHtml = `<tr><td colspan="${colspan}" class="text-center text-muted py-2">No KPI data available for this period.</td></tr>`;
      }
      tableBody.innerHTML = rowsHtml;
    };

    const toProspectMixedData = (periodData) => {
      const details = periodData.details || {};
      const users = Object.keys(details).sort();
      const assigned = [];
      const converted = [];
      const rates = [];

      users.forEach((user) => {
        const byPeriod = details[user] || {};
        let assignedTotal = 0;
        let convertedTotal = 0;
        Object.keys(byPeriod).forEach((periodLabel) => {
          const row = byPeriod[periodLabel] || {};
          assignedTotal += Number(row.assigned || 0);
          convertedTotal += Number(row.converted || 0);
        });
        assigned.push(assignedTotal);
        converted.push(convertedTotal);
        rates.push(assignedTotal ? Number(((convertedTotal / assignedTotal) * 100).toFixed(1)) : 0);
      });

      return {
        labels: users,
        datasets: [{
          label: "Assigned",
          data: assigned,
          backgroundColor: "rgba(13, 110, 253, 1)",
          borderColor: "#0d6efd",
          borderWidth: 2,
          barThickness: 15,
          barPercentage: 1.0,
          categoryPercentage: 0.5,
          inflateAmount: 0,
          yAxisID: "y",
        }, {
          label: "Converted",
          data: converted,
          backgroundColor: "rgba(25, 135, 84, 1)",
          borderColor: "#198754",
          borderWidth: 2,
          barThickness: 15,
          barPercentage: 1.0,
          categoryPercentage: 0.5,
          inflateAmount: 0,
          yAxisID: "y",
        }, {
          type: "line",
          label: "Conversion %",
          data: rates,
          borderColor: "#dc3545",
          backgroundColor: "#dc3545",
          pointRadius: 2,
          tension: 0.25,
          yAxisID: "y1",
          maxBarThickness: 18,
        }],
      };
    };

    const initKpiCard = (config) => {
      const payloadEl = document.getElementById(config.payloadId);
      const chartEl = document.getElementById(config.chartId);
      const tableBody = document.querySelector(`#${config.tableId} tbody`);
      if (!payloadEl || !chartEl) return;

      const data = JSON.parse(payloadEl.textContent || "{}");
      const initialPeriod = "daily";
      const initialPeriodData = data[initialPeriod] || { labels: [], datasets: [] };
      const initialChartData = config.transformChartData ? config.transformChartData(initialPeriodData) : initialPeriodData;

      if (window[config.chartHandle] && typeof window[config.chartHandle].destroy === "function") {
        window[config.chartHandle].destroy();
      }

      const chart = new Chart(chartEl, {
        type: config.chartType || "line",
        data: {
          labels: initialChartData.labels || [],
          datasets: withColors(initialChartData.datasets || []),
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: config.scales || { y: config.yScale },
          plugins: {
            tooltip: {
              callbacks: {
                label: (context) => (
                  config.tooltipLabel
                    ? config.tooltipLabel(context)
                    : `${context.dataset.label}: ${config.tooltipFormatter(context.parsed.y)}`
                )
              }
            }
          }
        }
      });
      window[config.chartHandle] = chart;
      renderTable(tableBody, initialPeriodData, config.tableMode);

      const buttons = document.querySelectorAll(config.buttonSelector);
      buttons.forEach((button) => {
        button.addEventListener("click", () => {
          const period = button.dataset[config.buttonDataset] || "daily";
          const periodData = data[period] || { labels: [], datasets: [] };
          const chartData = config.transformChartData ? config.transformChartData(periodData) : periodData;

          buttons.forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");

          chart.data.labels = chartData.labels || [];
          chart.data.datasets = withColors(chartData.datasets || []);
          chart.update();
          renderTable(tableBody, periodData, config.tableMode);
        });
      });
    };

    initKpiCard({
      payloadId: "prospect-conversion-kpi-data",
      chartId: "prospectConversionChart",
      tableId: "prospectConversionTable",
      chartHandle: "prospectConversionChart",
      chartType: "bar",
      transformChartData: toProspectMixedData,
      buttonSelector: "[data-kpi-period-prospect]",
      buttonDataset: "kpiPeriodProspect",
      tableMode: "prospect_rate",
      yScale: {
        beginAtZero: true,
        ticks: { precision: 0 },
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: "Count" },
          ticks: { precision: 0 },
        },
        y1: {
          beginAtZero: true,
          max: 100,
          position: "right",
          grid: { drawOnChartArea: false },
          title: { display: true, text: "Conversion %" },
          ticks: { callback: (value) => `${value}%` },
        },
      },
      tooltipLabel: (context) => {
        if (context.dataset.yAxisID === "y1") {
          return `${context.dataset.label}: ${context.parsed.y}%`;
        }
        return `${context.dataset.label}: ${Math.round(context.parsed.y)}`;
      },
      tooltipFormatter: (value) => `${value}`
    });
  })();
</script>
{% endblock %}
