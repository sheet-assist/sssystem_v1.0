{% extends "base.html" %}

{% block title %}Dashboard - SSSys{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">Dashboard</h2>
  {% if is_admin %}
  <button type="button" id="toggleProspectRevenue" class="btn btn-sm btn-outline-secondary">
    <i class="bi bi-eye"></i> Show Prospect Revenue
  </button>
  {% endif %}
</div>

<div class="card mb-3">
  <div class="card-body py-2 d-flex justify-content-end">
    <div class="d-flex flex-wrap align-items-center gap-2 justify-content-end">
      <small class="text-muted me-2">Auction Range: <span id="auctionRangeLabel">{{ auction_range_label }}</span></small>
      <strong class="small text-muted">Cards Filter</strong>
      <div class="btn-group btn-group-sm" role="group" aria-label="Cards Filter Period">
        <button type="button" class="btn btn-outline-success {% if cards_filter_mode == 'all' %}active{% endif %}" id="cardsModeAll">All</button>
        <button type="button" class="btn btn-outline-success {% if cards_filter_mode == '30days' %}active{% endif %}" id="cardsMode30">30 Days</button>
        <button type="button" class="btn btn-outline-success {% if cards_filter_mode == 'month' %}active{% endif %}" id="cardsModeMonth">Month</button>
      </div>
      <div class="d-flex align-items-center gap-1">
        <button type="button" class="btn btn-sm btn-outline-secondary {% if cards_filter_mode == 'all' %}disabled{% endif %}" id="cardsPrev" title="Previous">&laquo;</button>
        <span class="badge bg-light text-dark border px-2 py-1" id="cardsPeriodLabel" style="width:220px;display:inline-block;text-align:center;font-size:.82rem;">
          {{ cards_filter_period_label }}
        </span>
        <button type="button" class="btn btn-sm btn-outline-secondary {% if cards_filter_mode == 'all' or cards_filter_is_latest %}disabled{% endif %}" id="cardsNext" title="Next">&raquo;</button>
      </div>
    </div>
  </div>
</div>

{# --- Top Stats Row --- #}
<div class="row row-cols-1 row-cols-sm-2 row-cols-xl-4 g-3 mb-4">
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="card-subtitle text-muted mb-2">Total Prospects</h6>
        <p class="fs-3 fw-semibold mb-0" id="cardTotalProspects">{{ total_prospects }}</p>
      </div>
      <div class="card-footer bg-transparent border-0 pt-0">
        <small>
          <span class="text-success"><span id="cardQualifiedCount">{{ qualified_count }}</span> qualified</span> /
          <span class="text-danger"><span id="cardDisqualifiedCount">{{ disqualified_count }}</span> disqualified</span> /
          <span class="text-warning"><span id="cardPendingCount">{{ pending_count }}</span> pending</span>
        </small>
        <div class="mt-1">
          <small>Qualified Surplus Amount: <span class="text-success">$<span id="cardQualifiedSurplus">{{ qualified_surplus_amount|floatformat:0 }}</span></span></small>
        </div>
        {% if is_admin %}
        <div id="prospectRevenueSection" style="display:none;">
          <div>
            <small>Qualified Revenue (<span id="cardTierPct">{{ ss_revenue_tier }}</span>%): <span class="text-primary">$<span id="cardTotalRevenue">{{ total_revenue|floatformat:0 }}</span></span></small>
          </div>
          <div class="table-responsive mt-2">
            <table class="table table-sm table-borderless mb-0 align-middle" style="font-size: 0.72rem;">
              <thead>
                <tr class="text-muted">
                  <th class="ps-0" title="Type: Prospect type code (TD, TL, SS, MF).">Type</th>
                  <th class="text-end" title="Prospect Count: Total number of prospects for this type.">P</th>
                  <th class="text-end" title="Qualified Count: Number of qualified prospects for this type.">Q</th>
                  <th class="text-end" title="Total Surplus: Sum of qualified surplus amounts for this type.">Surplus</th>
                  <th class="text-end pe-0" title="Prospect Revenue: Revenue calculated from qualified surplus using the configured tier.">Rev</th>
                </tr>
              </thead>
              <tbody id="cardProspectRevTypeBody">
                {% for item in revenue_distribution_prospects_by_type %}
                <tr>
                  <td class="ps-0"><span class="badge bg-secondary">{{ item.code }}</span></td>
                  <td class="text-end">{{ item.prospect_count }}</td>
                  <td class="text-end">{{ item.qualified_count }}</td>
                  <td class="text-end">${{ item.total_surplus|floatformat:0 }}</td>
                  <td class="text-end pe-0">${{ item.prospect_revenue|floatformat:0 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="card-subtitle text-muted mb-2">Active Cases</h6>
        <p class="fs-3 fw-semibold mb-0" id="cardActiveCases">{{ active_cases }}</p>
      </div>
      <div class="card-footer bg-transparent border-0 pt-0">
        <small><span id="cardTotalCases">{{ total_cases }}</span> total &middot; <span class="text-success"><span id="cardClosedWon">{{ closed_won }}</span> won</span> &middot; <span class="text-danger"><span id="cardClosedLost">{{ closed_lost }}</span> lost</span></small>
        {% if is_admin %}
        <div class="mt-1">
          <small>Surplus Amount: <span class="text-success">$<span id="cardCaseQualifiedSurplus">{{ case_qualified_prospect_amount|floatformat:0 }}</span></span></small>
        </div>
        <div>
          <small>Case Revenue (<span id="cardTierPct2">{{ ss_revenue_tier }}</span>%): <span class="text-primary">$<span id="cardCaseRevenue">{{ case_revenue|floatformat:0 }}</span></span></small>
        </div>
        <div>
          <small>Invoice Paid Revenue: <span class="text-dark">$<span id="cardInvoicePaidRevenue">{{ invoice_paid_revenue|floatformat:0 }}</span></span></small>
        </div>
        <div class="table-responsive mt-2">
          <table class="table table-sm table-borderless mb-0 align-middle" style="font-size: 0.72rem;">
            <thead>
              <tr class="text-muted">
                <th class="ps-0" title="Type: Case type code (TD, TL, SS, MF).">Type</th>
                <th class="text-end" title="Case Count: Total cases for this type.">C</th>
                <th class="text-end" title="Invoice Paid Count: Cases with status set to Invoice Paid.">IP</th>
                <th class="text-end" title="Prospect Revenue: Revenue from qualified case-linked prospect surplus for this type.">Rev</th>
                <th class="text-end pe-0" title="Invoice Paid Revenue: Revenue from qualified surplus where case status is Invoice Paid.">IP Rev</th>
              </tr>
            </thead>
            <tbody id="cardCaseRevTypeBody">
              {% for item in revenue_distribution_cases_by_type %}
              <tr>
                <td class="ps-0"><span class="badge bg-secondary">{{ item.code }}</span></td>
                <td class="text-end">{{ item.total_case_count }}</td>
                <td class="text-end">{{ item.invoice_paid_count }}</td>
                <td class="text-end">${{ item.prospect_rev|floatformat:0 }}</td>
                <td class="text-end pe-0">${{ item.invoice_paid_rev|floatformat:0 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="card-subtitle text-muted mb-2">Conversion Rate</h6>
        <p class="fs-3 fw-semibold mb-0"><span id="cardConversionRate">{{ conversion_rate }}</span>%</p>
      </div>
      <div class="card-footer bg-transparent border-0 pt-0">
        <small><span id="cardConvertedCount">{{ converted_count }}</span> of <span id="cardConversionQualifiedTotal">{{ conversion_qualified_total }}</span> qualified prospects converted</small>
        <div class="table-responsive mt-2">
          <table class="table table-sm table-borderless mb-0 align-middle" style="font-size: 0.72rem;">
            <thead>
              <tr class="text-muted">
                <th class="ps-0" title="Type: Prospect type code (TD, TL, SS, MF).">Type</th>
                <th class="text-end" title="Count: Total prospects for this type.">Count</th>
                <th class="text-end" title="Converted: Prospects with workflow status Converted.">Converted</th>
                <th class="text-end pe-0" title="Conversion %: Converted divided by total prospects for this type.">Conv %</th>
              </tr>
            </thead>
            <tbody id="cardConversionTypeBody">
              {% for item in conversion_by_type %}
              <tr>
                <td class="ps-0"><span class="badge bg-secondary">{{ item.code }}</span></td>
                <td class="text-end">{{ item.count }}</td>
                <td class="text-end">{{ item.converted_count }}</td>
                <td class="text-end pe-0">{{ item.conversion_percent|floatformat:1 }}%</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="card-subtitle text-muted mb-2">Touched / Untouched</h6>
        <p class="fs-3 fw-semibold mb-0"><span id="cardTouchedCount">{{ touched_count }}</span> / <span id="cardUntouchedCount">{{ untouched_count }}</span></p>
      </div>
      <div class="card-footer bg-transparent border-0 pt-0">
        <small>
          <span class="text-warning"><span id="cardTouchedInProgress">{{ touched_in_progress_count }}</span> in progress</span> /
          <span class="text-secondary"><span id="cardTouchedClosed">{{ touched_closed_count }}</span> closed</span>
        </small>
        <div class="table-responsive mt-2">
          <table class="table table-sm table-borderless mb-0 align-middle" style="font-size: 0.72rem;">
            <thead>
              <tr class="text-muted">
                <th class="ps-0" title="Type: Prospect type code (TD, TL, SS, MF).">Type</th>
                <th class="text-end" title="New: Qualified prospects still in workflow status New.">New</th>
                <th class="text-end" title="In Progress: Qualified prospects in Assigned/Researching/Skip Tracing/Contacting/Contract Sent.">In Prog</th>
                <th class="text-end pe-0" title="Closed: Qualified prospects in Converted or Dead status.">Closed</th>
              </tr>
            </thead>
            <tbody id="cardTouchedTypeBody">
              {% for item in touched_by_type %}
              <tr>
                <td class="ps-0"><span class="badge bg-secondary">{{ item.code }}</span></td>
                <td class="text-end">{{ item.new_count }}</td>
                <td class="text-end">{{ item.in_progress_count }}</td>
                <td class="text-end pe-0">{{ item.closed_count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{# --- Daily Qualified Trend --- #}
<div class="card mb-4">
  <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
    <strong>Daily Qualified Count</strong>
    <div class="d-flex align-items-center gap-2">
      <div class="btn-group btn-group-sm" role="group" aria-label="Daily Qualified Period">
        <button type="button" class="btn btn-outline-success active" data-dq-mode="30days">30 Days</button>
        <button type="button" class="btn btn-outline-success" data-dq-mode="month">Month</button>
      </div>
      <div class="d-flex align-items-center gap-1">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="dqPrev" title="Previous">&laquo;</button>
        <span class="badge bg-light text-dark border px-2 py-1" id="dqPeriodLabel" style="min-width:180px;text-align:center;font-size:.82rem;">
          Loadingâ€¦
        </span>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="dqNext" title="Next">&raquo;</button>
      </div>
    </div>
  </div>
  <div class="card-body py-2">
    <div class="position-relative" style="height: 180px;">
      <canvas id="dailyQualifiedChart"></canvas>
    </div>
  </div>
</div>

{# --- Prospect Conversion Chart --- #}
<div class="card mb-4">
  <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
    <strong>Prospect Conversion % (Assigned to Converted by User)</strong>
    <div class="btn-group btn-group-sm" role="group" aria-label="Prospect Conversion Period">
      <button type="button" class="btn btn-outline-success active" data-kpi-period-prospect="daily">Daily</button>
      <button type="button" class="btn btn-outline-success" data-kpi-period-prospect="monthly">Monthly</button>
      <button type="button" class="btn btn-outline-success" data-kpi-period-prospect="yearly">Yearly</button>
    </div>
  </div>
  <div class="card-body">
    <div class="position-relative" style="height: 320px;">
      <canvas id="prospectConversionChart"></canvas>
    </div>
    <small class="text-muted d-block mt-2">
      Conversion % = converted prospects / assigned prospects in period, grouped by user.
    </small>
    <div class="table-responsive mt-3">
      <table class="table table-sm table-striped mb-0" id="prospectConversionTable">
        <thead>
          <tr>
            <th>Period</th>
            <th>User</th>
            <th class="text-end">Assigned</th>
            <th class="text-end">Converted</th>
            <th class="text-end">Conversion %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

{# --- Pipeline Row --- #}
<div class="card mb-4">
  <div class="card-header"><strong>Prospect Pipeline</strong></div>
  <div class="card-body">
    <div class="row text-center">
      {% for label, count in pipeline %}
      <div class="col">
        <div class="border rounded p-2">
          <small class="text-muted d-block">{{ label }}</small>
          <span class="fs-4 fw-bold">{{ count }}</span>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<div class="row">
  {# --- Left: Recent Activity --- #}
  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-header"><strong>Recent Activity</strong></div>
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <tbody>
            {% for item in recent_activity %}
            <tr>
              <td style="width:140px;"><small class="text-muted">{{ item.time|date:"M d, H:i" }}</small></td>
              <td>
                {% if item.type == "prospect" %}
                  <span class="badge bg-info">Prospect</span>
                {% else %}
                  <span class="badge bg-primary">Case</span>
                {% endif %}
              </td>
              <td><a href="{{ item.url }}">{{ item.ref }}</a></td>
              <td>{{ item.action }}</td>
              <td class="text-muted">{{ item.user.username|default:"System" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="text-center text-muted py-3">No activity yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# --- Right: Quick Actions & Scraper --- #}
  <div class="col-lg-4">
    {# Quick Actions #}
    <div class="card mb-4">
      <div class="card-header"><strong>Quick Actions</strong></div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{% url 'prospects:type_select' %}" class="btn btn-outline-primary btn-sm">Browse Prospects</a>
          <a href="{% url 'cases:list' %}" class="btn btn-outline-secondary btn-sm">View Cases</a>
          {% if is_admin %}
          <a href="{% url 'scraper:job_create' %}" class="btn btn-outline-success btn-sm">New Scrape Job</a>
          <a href="{% url 'settings_app:criteria_list' %}" class="btn btn-outline-warning btn-sm">Filter Criteria</a>
          {% endif %}
        </div>
      </div>
    </div>

    {# Scraper Status (admin only) #}
    {% if is_admin %}
    <div class="card mb-4">
      <div class="card-header"><strong>Scraper Status</strong></div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-7">Total Jobs</dt>
          <dd class="col-5">{{ total_scrape_jobs }}</dd>
          <dt class="col-7">Running</dt>
          <dd class="col-5">
            {% if running_jobs > 0 %}
              <span class="badge bg-warning text-dark">{{ running_jobs }}</span>
            {% else %}
              0
            {% endif %}
          </dd>
          <dt class="col-7">Last Job</dt>
          <dd class="col-5">
            {% if last_scrape_job %}
              <a href="{% url 'scraper:job_detail' last_scrape_job.pk %}">
                #{{ last_scrape_job.pk }}
                {% if last_scrape_job.status == "completed" %}<span class="badge bg-success">OK</span>
                {% elif last_scrape_job.status == "failed" %}<span class="badge bg-danger">Failed</span>
                {% elif last_scrape_job.status == "running" %}<span class="badge bg-warning text-dark">Running</span>
                {% else %}<span class="badge bg-secondary">Pending</span>{% endif %}
              </a>
            {% else %}
              -
            {% endif %}
          </dd>
        </dl>
        <a href="{% url 'scraper:dashboard' %}" class="btn btn-sm btn-outline-dark mt-2 w-100">Go to Scraper</a>
      </div>
    </div>
    {% endif %}

    {# My Stats (non-admin) #}
    {% if not is_admin %}
    <div class="card mb-4">
      <div class="card-header"><strong>My Work</strong></div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-8">My Prospects</dt>
          <dd class="col-4">{{ my_prospects }}</dd>
          <dt class="col-8">My Cases</dt>
          <dd class="col-4">{{ my_cases }}</dd>
        </dl>
        <a href="{% url 'prospects:my_prospects' %}" class="btn btn-sm btn-outline-primary mt-2 w-100">View My Prospects</a>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
{{ daily_qualified_chart|json_script:"daily-qualified-chart-data" }}
{{ prospect_conversion_kpi|json_script:"prospect-conversion-kpi-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function() {
    if (typeof Chart === "undefined") return;

    const palette = [
      "#0d6efd", "#198754", "#dc3545", "#fd7e14", "#6f42c1", "#20c997", "#6610f2", "#0dcaf0"
    ];

    const withColors = (datasets) => datasets.map((dataset, index) => ({
      ...dataset,
      borderColor: dataset.borderColor || palette[index % palette.length],
      backgroundColor: dataset.backgroundColor || palette[index % palette.length],
      tension: dataset.tension ?? 0.25,
      fill: dataset.fill ?? false,
      pointRadius: dataset.pointRadius ?? 3
    }));

    const dailyPayloadEl = document.getElementById("daily-qualified-chart-data");
    const dailyChartEl = document.getElementById("dailyQualifiedChart");
    if (dailyPayloadEl && dailyChartEl) {
      const dailyData = JSON.parse(dailyPayloadEl.textContent || "{}");
      if (window.dailyQualifiedChart && typeof window.dailyQualifiedChart.destroy === "function") {
        window.dailyQualifiedChart.destroy();
      }
      const qualifiedBarLabelPlugin = {
        id: "qualifiedBarLabelPlugin",
        afterDatasetsDraw(chart) {
          const ctx = chart.ctx;
          const qualifiedMeta = chart.getDatasetMeta(0);
          const qualifiedDataset = chart.data.datasets[0];
          if (!qualifiedMeta || !qualifiedDataset) return;

          ctx.save();
          ctx.fillStyle = "#146c43";
          ctx.font = "11px sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "bottom";

          qualifiedMeta.data.forEach((bar, index) => {
            const value = qualifiedDataset.data?.[index];
            if (value === null || value === undefined) return;
            ctx.fillText(String(value), bar.x, bar.y - 4);
          });
          ctx.restore();
        },
      };
      window.dailyQualifiedChart = new Chart(dailyChartEl, {
        type: "bar",
        plugins: [qualifiedBarLabelPlugin],
        data: {
          labels: dailyData.labels || [],
          datasets: [{
            label: "Qualified Count",
            data: dailyData.qualified_counts || [],
            backgroundColor: "rgba(25, 135, 84, 0.75)",
            borderColor: "#198754",
            borderWidth: 1,
            maxBarThickness: 14,
            barPercentage: 0.5,
            categoryPercentage: 0.7,
          }, {
            label: "Disqualified Count",
            data: dailyData.disqualified_counts || [],
            backgroundColor: "rgba(220, 53, 69, 0.75)",
            borderColor: "#dc3545",
            borderWidth: 1,
            maxBarThickness: 14,
            barPercentage: 0.5,
            categoryPercentage: 0.7,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 },
              title: { display: true, text: "Qualified Count" },
            },
            x: {
              title: { display: true, text: "Date" },
            },
          },
        },
      });

      // --- Daily Qualified chart navigation ---
      const dqPeriodLabel = document.getElementById("dqPeriodLabel");
      const dqPrevBtn = document.getElementById("dqPrev");
      const dqNextBtn = document.getElementById("dqNext");
      const dqModeButtons = document.querySelectorAll("[data-dq-mode]");
      const DQ_API_URL = "{% url 'dashboard:daily_qualified_api' %}";

      // State
      let dqMode = "30days";
      let dqStart = dailyData.labels?.[0] || null;
      let dqEnd = dailyData.labels?.[dailyData.labels.length - 1] || null;

      // Derive initial period label
      function formatLabel(start, end) {
        const opts = { month: "short", day: "numeric", year: "numeric" };
        const s = new Date(start + "T00:00:00");
        const e = new Date(end + "T00:00:00");
        return s.toLocaleDateString("en-US", opts) + " \u2013 " + e.toLocaleDateString("en-US", opts);
      }
      if (dqStart && dqEnd) {
        dqPeriodLabel.textContent = formatLabel(dqStart, dqEnd);
      }
      dqNextBtn.disabled = true; // initial load is latest

      function updateDqChart(data) {
        const chart = window.dailyQualifiedChart;
        chart.data.labels = data.labels || [];
        chart.data.datasets[0].data = data.qualified_counts || [];
        chart.data.datasets[1].data = data.disqualified_counts || [];
        chart.update();
        dqStart = data.start;
        dqEnd = data.end;
        dqPeriodLabel.textContent = data.period_label || "";
        dqNextBtn.disabled = !!data.is_latest;
      }

      async function fetchDq(params) {
        const qs = new URLSearchParams(params).toString();
        try {
          const resp = await fetch(`${DQ_API_URL}?${qs}`);
          if (!resp.ok) return;
          const data = await resp.json();
          updateDqChart(data);
        } catch (e) {
          console.error("Failed to fetch daily qualified data", e);
        }
      }

      // Mode toggle
      dqModeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          dqModeButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          dqMode = btn.dataset.dqMode;
          // Fetch latest for chosen mode
          if (dqMode === "month") {
            const today = new Date();
            fetchDq({ mode: "month", year: today.getFullYear(), month: today.getMonth() + 1 });
          } else {
            fetchDq({ mode: "30days" });
          }
        });
      });

      // Helper to shift dates
      function addDays(dateStr, days) {
        const d = new Date(dateStr + "T00:00:00");
        d.setDate(d.getDate() + days);
        return d.toISOString().slice(0, 10);
      }

      function shiftMonth(dateStr, delta) {
        const d = new Date(dateStr + "T00:00:00");
        d.setMonth(d.getMonth() + delta);
        return { year: d.getFullYear(), month: d.getMonth() + 1 };
      }

      dqPrevBtn.addEventListener("click", () => {
        if (dqMode === "month") {
          const prev = shiftMonth(dqStart, -1);
          fetchDq({ mode: "month", year: prev.year, month: prev.month });
        } else {
          const newEnd = addDays(dqStart, -1);
          const newStart = addDays(newEnd, -29);
          fetchDq({ mode: "30days", start: newStart, end: newEnd });
        }
      });

      dqNextBtn.addEventListener("click", () => {
        if (dqMode === "month") {
          const nxt = shiftMonth(dqStart, 1);
          fetchDq({ mode: "month", year: nxt.year, month: nxt.month });
        } else {
          const newStart = addDays(dqEnd, 1);
          const newEnd = addDays(newStart, 29);
          fetchDq({ mode: "30days", start: newStart, end: newEnd });
        }
      });
    }

    const renderTable = (tableBody, periodData, mode) => {
      if (!tableBody) return;
      const labels = periodData.labels || [];
      const datasets = periodData.datasets || [];
      let rowsHtml = "";

      labels.forEach((label, labelIndex) => {
        datasets.forEach((dataset) => {
          const value = Number(dataset.data?.[labelIndex] ?? 0);
          if (mode === "case_rate" || mode === "prospect_rate") {
            const details = (periodData.details || {})[dataset.label] || {};
            const detailRow = details[label] || { assigned: 0, converted: 0, conversion_rate: value };
            rowsHtml += `
              <tr>
                <td>${label}</td>
                <td>${dataset.label}</td>
                <td class="text-end">${Math.round(detailRow.assigned || 0)}</td>
                <td class="text-end">${Math.round(detailRow.converted || 0)}</td>
                <td class="text-end">${Number(detailRow.conversion_rate || value).toFixed(1)}%</td>
              </tr>
            `;
          } else {
            const renderedValue = mode === "percent" ? `${value.toFixed(1)}%` : `${Math.round(value)}`;
            rowsHtml += `
              <tr>
                <td>${label}</td>
                <td>${dataset.label}</td>
                <td class="text-end">${renderedValue}</td>
              </tr>
            `;
          }
        });
      });

      if (!rowsHtml) {
        const colspan = (mode === "case_rate" || mode === "prospect_rate") ? 5 : 3;
        rowsHtml = `<tr><td colspan="${colspan}" class="text-center text-muted py-2">No KPI data available for this period.</td></tr>`;
      }
      tableBody.innerHTML = rowsHtml;
    };

    const toProspectMixedData = (periodData) => {
      const details = periodData.details || {};
      const users = Object.keys(details).sort();
      const assigned = [];
      const converted = [];
      const rates = [];

      users.forEach((user) => {
        const byPeriod = details[user] || {};
        let assignedTotal = 0;
        let convertedTotal = 0;
        Object.keys(byPeriod).forEach((periodLabel) => {
          const row = byPeriod[periodLabel] || {};
          assignedTotal += Number(row.assigned || 0);
          convertedTotal += Number(row.converted || 0);
        });
        assigned.push(assignedTotal);
        converted.push(convertedTotal);
        rates.push(assignedTotal ? Number(((convertedTotal / assignedTotal) * 100).toFixed(1)) : 0);
      });

      return {
        labels: users,
        datasets: [{
          label: "Assigned",
          data: assigned,
          backgroundColor: "rgba(13, 110, 253, 1)",
          borderColor: "#0d6efd",
          borderWidth: 2,
          barThickness: 15,
          barPercentage: 1.0,
          categoryPercentage: 0.5,
          inflateAmount: 0,
          yAxisID: "y",
        }, {
          label: "Converted",
          data: converted,
          backgroundColor: "rgba(25, 135, 84, 1)",
          borderColor: "#198754",
          borderWidth: 2,
          barThickness: 15,
          barPercentage: 1.0,
          categoryPercentage: 0.5,
          inflateAmount: 0,
          yAxisID: "y",
        }, {
          type: "line",
          label: "Conversion %",
          data: rates,
          borderColor: "#dc3545",
          backgroundColor: "#dc3545",
          pointRadius: 2,
          tension: 0.25,
          yAxisID: "y1",
          maxBarThickness: 18,
        }],
      };
    };

    const initKpiCard = (config) => {
      const payloadEl = document.getElementById(config.payloadId);
      const chartEl = document.getElementById(config.chartId);
      const tableBody = document.querySelector(`#${config.tableId} tbody`);
      if (!payloadEl || !chartEl) return;

      const data = JSON.parse(payloadEl.textContent || "{}");
      const initialPeriod = "daily";
      const initialPeriodData = data[initialPeriod] || { labels: [], datasets: [] };
      const initialChartData = config.transformChartData ? config.transformChartData(initialPeriodData) : initialPeriodData;

      if (window[config.chartHandle] && typeof window[config.chartHandle].destroy === "function") {
        window[config.chartHandle].destroy();
      }

      const chart = new Chart(chartEl, {
        type: config.chartType || "line",
        data: {
          labels: initialChartData.labels || [],
          datasets: withColors(initialChartData.datasets || []),
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: config.scales || { y: config.yScale },
          plugins: {
            tooltip: {
              callbacks: {
                label: (context) => (
                  config.tooltipLabel
                    ? config.tooltipLabel(context)
                    : `${context.dataset.label}: ${config.tooltipFormatter(context.parsed.y)}`
                )
              }
            }
          }
        }
      });
      window[config.chartHandle] = chart;
      renderTable(tableBody, initialPeriodData, config.tableMode);

      const buttons = document.querySelectorAll(config.buttonSelector);
      buttons.forEach((button) => {
        button.addEventListener("click", () => {
          const period = button.dataset[config.buttonDataset] || "daily";
          const periodData = data[period] || { labels: [], datasets: [] };
          const chartData = config.transformChartData ? config.transformChartData(periodData) : periodData;

          buttons.forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");

          chart.data.labels = chartData.labels || [];
          chart.data.datasets = withColors(chartData.datasets || []);
          chart.update();
          renderTable(tableBody, periodData, config.tableMode);
        });
      });
    };

    initKpiCard({
      payloadId: "prospect-conversion-kpi-data",
      chartId: "prospectConversionChart",
      tableId: "prospectConversionTable",
      chartHandle: "prospectConversionChart",
      chartType: "bar",
      transformChartData: toProspectMixedData,
      buttonSelector: "[data-kpi-period-prospect]",
      buttonDataset: "kpiPeriodProspect",
      tableMode: "prospect_rate",
      yScale: {
        beginAtZero: true,
        ticks: { precision: 0 },
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: "Count" },
          ticks: { precision: 0 },
        },
        y1: {
          beginAtZero: true,
          max: 100,
          position: "right",
          grid: { drawOnChartArea: false },
          title: { display: true, text: "Conversion %" },
          ticks: { callback: (value) => `${value}%` },
        },
      },
      tooltipLabel: (context) => {
        if (context.dataset.yAxisID === "y1") {
          return `${context.dataset.label}: ${context.parsed.y}%`;
        }
        return `${context.dataset.label}: ${Math.round(context.parsed.y)}`;
      },
      tooltipFormatter: (value) => `${value}`
    });

    // --- Cards stats filter (no page reload) ---
    const cardsApiUrl = "{% url 'dashboard:cards_stats_api' %}";
    const cardsModeAllBtn = document.getElementById("cardsModeAll");
    const cardsMode30Btn = document.getElementById("cardsMode30");
    const cardsModeMonthBtn = document.getElementById("cardsModeMonth");
    const cardsPrevBtn = document.getElementById("cardsPrev");
    const cardsNextBtn = document.getElementById("cardsNext");
    const cardsPeriodLabel = document.getElementById("cardsPeriodLabel");

    let cardsMode = "{{ cards_filter_mode }}";
    let cardsStart = "{{ cards_filter_start }}";
    let cardsEnd = "{{ cards_filter_end }}";

    const fmtInt = (v) => Number(v || 0).toLocaleString("en-US", { maximumFractionDigits: 0 });
    const fmtMoney = (v) => Number(v || 0).toLocaleString("en-US", { maximumFractionDigits: 0 });

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function setCardsButtons(mode, isLatest) {
      cardsModeAllBtn?.classList.toggle("active", mode === "all");
      cardsMode30Btn?.classList.toggle("active", mode === "30days");
      cardsModeMonthBtn?.classList.toggle("active", mode === "month");

      if (cardsPrevBtn) cardsPrevBtn.classList.toggle("disabled", mode === "all");
      if (cardsNextBtn) cardsNextBtn.classList.toggle("disabled", mode === "all" || !!isLatest);
    }

    function renderTableRows(tbodyId, rows, mapper) {
      const tbody = document.getElementById(tbodyId);
      if (!tbody) return;
      tbody.innerHTML = (rows || []).map(mapper).join("");
    }

    function updateCards(data) {
      cardsMode = data.cards_filter_mode || cardsMode;
      cardsStart = data.cards_filter_start || "";
      cardsEnd = data.cards_filter_end || "";
      if (cardsPeriodLabel) cardsPeriodLabel.textContent = data.cards_filter_period_label || "All Time";
      setText("auctionRangeLabel", data.auction_range_label || "-");
      setCardsButtons(cardsMode, data.cards_filter_is_latest);

      setText("cardTotalProspects", fmtInt(data.total_prospects));
      setText("cardQualifiedCount", fmtInt(data.qualified_count));
      setText("cardDisqualifiedCount", fmtInt(data.disqualified_count));
      setText("cardPendingCount", fmtInt(data.pending_count));
      setText("cardQualifiedSurplus", fmtMoney(data.qualified_surplus_amount));
      setText("cardTotalRevenue", fmtMoney(data.total_revenue));
      setText("cardTierPct", data.ss_revenue_tier ?? "");
      setText("cardTierPct2", data.ss_revenue_tier ?? "");

      renderTableRows("cardProspectRevTypeBody", data.revenue_distribution_prospects_by_type, (item) => `
        <tr>
          <td class="ps-0"><span class="badge bg-secondary">${item.code}</span></td>
          <td class="text-end">${fmtInt(item.prospect_count)}</td>
          <td class="text-end">${fmtInt(item.qualified_count)}</td>
          <td class="text-end">$${fmtMoney(item.total_surplus)}</td>
          <td class="text-end pe-0">$${fmtMoney(item.prospect_revenue)}</td>
        </tr>
      `);

      setText("cardActiveCases", fmtInt(data.active_cases));
      setText("cardTotalCases", fmtInt(data.total_cases));
      setText("cardClosedWon", fmtInt(data.closed_won));
      setText("cardClosedLost", fmtInt(data.closed_lost));
      setText("cardCaseQualifiedSurplus", fmtMoney(data.case_qualified_prospect_amount));
      setText("cardCaseRevenue", fmtMoney(data.case_revenue));
      setText("cardInvoicePaidRevenue", fmtMoney(data.invoice_paid_revenue));

      renderTableRows("cardCaseRevTypeBody", data.revenue_distribution_cases_by_type, (item) => `
        <tr>
          <td class="ps-0"><span class="badge bg-secondary">${item.code}</span></td>
          <td class="text-end">${fmtInt(item.total_case_count)}</td>
          <td class="text-end">${fmtInt(item.invoice_paid_count)}</td>
          <td class="text-end">$${fmtMoney(item.prospect_rev)}</td>
          <td class="text-end pe-0">$${fmtMoney(item.invoice_paid_rev)}</td>
        </tr>
      `);

      setText("cardConversionRate", Number(data.conversion_rate || 0).toFixed(1));
      setText("cardConvertedCount", fmtInt(data.converted_count));
      setText("cardConversionQualifiedTotal", fmtInt(data.conversion_qualified_total));
      renderTableRows("cardConversionTypeBody", data.conversion_by_type, (item) => `
        <tr>
          <td class="ps-0"><span class="badge bg-secondary">${item.code}</span></td>
          <td class="text-end">${fmtInt(item.count)}</td>
          <td class="text-end">${fmtInt(item.converted_count)}</td>
          <td class="text-end pe-0">${Number(item.conversion_percent || 0).toFixed(1)}%</td>
        </tr>
      `);

      setText("cardTouchedCount", fmtInt(data.touched_count));
      setText("cardUntouchedCount", fmtInt(data.untouched_count));
      setText("cardTouchedInProgress", fmtInt(data.touched_in_progress_count));
      setText("cardTouchedClosed", fmtInt(data.touched_closed_count));
      renderTableRows("cardTouchedTypeBody", data.touched_by_type, (item) => `
        <tr>
          <td class="ps-0"><span class="badge bg-secondary">${item.code}</span></td>
          <td class="text-end">${fmtInt(item.new_count)}</td>
          <td class="text-end">${fmtInt(item.in_progress_count)}</td>
          <td class="text-end pe-0">${fmtInt(item.closed_count)}</td>
        </tr>
      `);
    }

    async function fetchCards(params) {
      try {
        const qs = new URLSearchParams(params).toString();
        const resp = await fetch(`${cardsApiUrl}?${qs}`);
        if (!resp.ok) return;
        const data = await resp.json();
        updateCards(data);
      } catch (e) {
        console.error("Failed to fetch cards stats", e);
      }
    }

    function cardsAddDays(dateStr, days) {
      const d = new Date(dateStr + "T00:00:00");
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0, 10);
    }

    function cardsShiftMonthFromDate(dateStr, delta) {
      const d = new Date(dateStr + "T00:00:00");
      d.setMonth(d.getMonth() + delta);
      return { year: d.getFullYear(), month: d.getMonth() + 1 };
    }

    cardsModeAllBtn?.addEventListener("click", () => fetchCards({ cards_mode: "all" }));
    cardsMode30Btn?.addEventListener("click", () => fetchCards({ cards_mode: "30days" }));
    cardsModeMonthBtn?.addEventListener("click", () => {
      const t = new Date();
      fetchCards({ cards_mode: "month", cards_year: t.getFullYear(), cards_month: t.getMonth() + 1 });
    });

    cardsPrevBtn?.addEventListener("click", () => {
      if (cardsPrevBtn.classList.contains("disabled")) return;
      if (cardsMode === "month" && cardsStart) {
        const prev = cardsShiftMonthFromDate(cardsStart, -1);
        fetchCards({ cards_mode: "month", cards_year: prev.year, cards_month: prev.month });
      } else if (cardsMode === "30days" && cardsStart) {
        const newEnd = cardsAddDays(cardsStart, -1);
        const newStart = cardsAddDays(newEnd, -29);
        fetchCards({ cards_mode: "30days", cards_start: newStart, cards_end: newEnd });
      }
    });

    cardsNextBtn?.addEventListener("click", () => {
      if (cardsNextBtn.classList.contains("disabled")) return;
      if (cardsMode === "month" && cardsStart) {
        const next = cardsShiftMonthFromDate(cardsStart, 1);
        fetchCards({ cards_mode: "month", cards_year: next.year, cards_month: next.month });
      } else if (cardsMode === "30days" && cardsEnd) {
        const newStart = cardsAddDays(cardsEnd, 1);
        const newEnd = cardsAddDays(newStart, 29);
        fetchCards({ cards_mode: "30days", cards_start: newStart, cards_end: newEnd });
      }
    });
  })();
</script>

<script>
  // Prospect Revenue Toggle
  (function () {
    const btn = document.getElementById('toggleProspectRevenue');
    const section = document.getElementById('prospectRevenueSection');
    if (!btn || !section) return;

    const KEY = 'dashboard_show_prospect_revenue';

    function applyState(show) {
      section.style.display = show ? '' : 'none';
      btn.innerHTML = show
        ? '<i class="bi bi-eye-slash"></i> Hide Prospect Revenue'
        : '<i class="bi bi-eye"></i> Show Prospect Revenue';
    }

    // Restore saved state (default: hidden)
    applyState(localStorage.getItem(KEY) === 'true');

    btn.addEventListener('click', function () {
      const nowVisible = section.style.display !== 'none';
      localStorage.setItem(KEY, String(!nowVisible));
      applyState(!nowVisible);
    });
  })();
</script>
{% endblock %}
