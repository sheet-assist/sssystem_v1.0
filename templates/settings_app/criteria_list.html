{% extends "base.html" %}

{% block title %}Filter Criteria{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Filter Criteria Rules</h2>
    <a href="{% url 'settings_app:criteria_add' %}" class="btn btn-primary">
      <i class="bi bi-plus-lg"></i> Add New Rule
    </a>
  </div>

  {% if criteria %}
  <div class="row g-2">
    {% for rule in criteria %}
    <div class="col-lg-6 col-xl-4">
      <div class="card h-100 {% if not rule.is_active %}opacity-50{% endif %}">
        <div class="card-header bg-light border-bottom p-2">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="card-title mb-1">
                {{ rule.name }}
                {% if rule.state %}
                  <span class="badge bg-info text-dark ms-1">{{ rule.state.abbreviation }}</span>
                {% endif %}
              </h6>
              <small class="text-muted d-block mb-1">
                {% with county_list=rule.counties.all %}
                  {% if county_list %}
                    {% if rule.state and county_list|length == rule.state.counties.count %}
                      <span class="badge bg-dark">All Counties</span>
                    {% else %}
                      {% for c in county_list %}
                        <span class="badge bg-dark">{{ c.name }}</span>
                      {% endfor %}
                    {% endif %}
                  {% elif rule.county %}
                    <span class="badge bg-dark">{{ rule.county.name }}</span>
                  {% endif %}
                {% endwith %}
              </small>
              <small class="text-muted">
                {% if rule.prospect_types %}
                  <span class="badge bg-secondary">{{ rule.prospect_types|join:", " }}</span>
                {% elif rule.prospect_type %}
                  <span class="badge bg-secondary">{{ rule.prospect_type }}</span>
                {% else %}
                  <span class="badge bg-secondary">All Types</span>
                {% endif %}
              </small>
            </div>
            <div>
              {% if rule.is_active %}
              <span class="badge bg-success">Active</span>
              {% else %}
              <span class="badge bg-secondary">Inactive</span>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="card-body p-2">
          <div class="mt-2 pt-2 border-top">
            <small class="text-muted d-block mb-1"><strong>Summary:</strong></small>
            <small class="d-block">{{ rule.get_verbose_summary }}</small>
          </div>

          <div class="mt-2">
            <button
              type="button"
              class="btn btn-outline-secondary btn-sm w-100 js-params-toggle"
              data-target-id="rule-params-{{ rule.pk }}"
              data-show-text="Show Parameters"
              data-hide-text="Hide Parameters"
            >
              Show Parameters
            </button>
          </div>

          <div id="rule-params-{{ rule.pk }}" class="parameters-panel d-none mt-2 pt-2 border-top">
            <div class="mb-2">
              <small class="text-muted d-block"><strong>Scope:</strong></small>
              <small>
                {% if rule.county %}
                  County: <strong>{{ rule.county.name }}</strong>
                {% elif rule.state %}
                  State: <strong>{{ rule.state.name }}</strong>
                {% else %}
                  <em>Global</em>
                {% endif %}
              </small>
            </div>

            <div class="mb-2">
              <small class="text-muted d-block mb-2"><strong>Financial Criteria:</strong></small>
              {% if rule.plaintiff_max_bid_min or rule.plaintiff_max_bid_max %}
              <div class="small mb-2">
                <strong>Plaintiff Max Bid:</strong>
                {% if rule.plaintiff_max_bid_min %}${{ rule.plaintiff_max_bid_min|floatformat:0 }}{% else %}-{% endif %}
                to
                {% if rule.plaintiff_max_bid_max %}${{ rule.plaintiff_max_bid_max|floatformat:0 }}{% else %}-{% endif %}
              </div>
              {% endif %}
              {% if rule.assessed_value_min or rule.assessed_value_max %}
              <div class="small mb-2">
                <strong>Assessed Value:</strong>
                {% if rule.assessed_value_min %}${{ rule.assessed_value_min|floatformat:0 }}{% else %}-{% endif %}
                to
                {% if rule.assessed_value_max %}${{ rule.assessed_value_max|floatformat:0 }}{% else %}-{% endif %}
              </div>
              {% endif %}
              {% if rule.final_judgment_min or rule.final_judgment_max %}
              <div class="small mb-2">
                <strong>Final Judgment:</strong>
                {% if rule.final_judgment_min %}${{ rule.final_judgment_min|floatformat:0 }}{% else %}-{% endif %}
                to
                {% if rule.final_judgment_max %}${{ rule.final_judgment_max|floatformat:0 }}{% else %}-{% endif %}
              </div>
              {% endif %}
              {% if rule.sale_amount_min or rule.sale_amount_max %}
              <div class="small">
                <strong>Sale Amount:</strong>
                {% if rule.sale_amount_min %}${{ rule.sale_amount_min|floatformat:0 }}{% else %}-{% endif %}
                to
                {% if rule.sale_amount_max %}${{ rule.sale_amount_max|floatformat:0 }}{% else %}-{% endif %}
              </div>
              {% endif %}
            </div>

            {% if rule.min_date or rule.max_date or rule.status_types %}
            <div class="mb-1">
              <small class="text-muted d-block mb-2"><strong>Other Criteria:</strong></small>
              {% if rule.min_date or rule.max_date %}
              <div class="small mb-2">
                <strong>Auction Dates:</strong>
                {% if rule.min_date %}From {{ rule.min_date }}{% else %}Any{% endif %}
                -
                {% if rule.max_date %}To {{ rule.max_date }}{% else %}Any{% endif %}
              </div>
              {% endif %}
              {% if rule.status_types %}
              <div class="small mb-2">
                <strong>Status Types:</strong> {{ rule.status_types|join:", " }}
              </div>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>

        <div class="card-footer bg-light p-2">
          <div class="d-flex gap-1">
            <form method="post" action="{% url 'settings_app:criteria_apply' rule.pk %}" class="d-inline flex-grow-1 js-apply-rule-form">
              {% csrf_token %}
              <button type="submit" class="btn btn-success btn-sm w-100 js-apply-rule-btn" style="font-size: 0.85rem; padding: 0.25rem 0.5rem;">
                <i class="bi bi-play-fill"></i> Apply Now
              </button>
            </form>
            <a href="{% url 'settings_app:criteria_edit' rule.pk %}" class="btn btn-outline-primary btn-sm flex-grow-1" style="font-size: 0.85rem; padding: 0.25rem 0.5rem;">
              <i class="bi bi-pencil"></i> Edit
            </a>
            <form method="post" action="{% url 'settings_app:criteria_delete' rule.pk %}" class="d-inline" onsubmit="return confirm('Delete this rule?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-sm" style="font-size: 0.85rem; padding: 0.25rem 0.5rem;">
                <i class="bi bi-trash"></i> Delete
              </button>
            </form>
          </div>
          <small class="text-muted d-block mt-2">
            Updated: {{ rule.updated_at|date:"M d, Y" }}
          </small>
          <div class="progress mt-2 d-none js-apply-progress" role="status" aria-live="polite">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success js-apply-progress-bar" style="width: 0%;">
               <span class="js-apply-progress-value">0%</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% include "includes/pagination.html" %}

  {% else %}
  <div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    No filter rules configured yet.
    <a href="{% url 'settings_app:criteria_add' %}" class="alert-link">Create your first rule</a>
  </div>
  {% endif %}
</div>

<style>
  .prospect-type-pill {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .card {
    transition: transform 0.2s, box-shadow 0.2s;
    font-size: 0.98rem;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .card .small {
    font-size: 0.88rem;
    line-height: 1.4;
  }
</style>
<script>
  (function () {
    const buttons = document.querySelectorAll('.js-params-toggle');
    buttons.forEach(function (btn) {
      btn.addEventListener('click', function () {
        const targetId = btn.getAttribute('data-target-id');
        const panel = document.getElementById(targetId);
        if (!panel) return;
        const isHidden = panel.classList.contains('d-none');
        panel.classList.toggle('d-none', !isHidden);
        btn.textContent = isHidden ? btn.getAttribute('data-hide-text') : btn.getAttribute('data-show-text');
      });
    });

    const applyForms = document.querySelectorAll('.js-apply-rule-form');
    applyForms.forEach(function (form) {
      form.addEventListener('submit', function () {
        const btn = form.querySelector('.js-apply-rule-btn');
        const footer = form.closest('.card-footer');
        const progress = footer ? footer.querySelector('.js-apply-progress') : null;
        const progressBar = footer ? footer.querySelector('.js-apply-progress-bar') : null;
        const progressValue = footer ? footer.querySelector('.js-apply-progress-value') : null;

        if (btn) {
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Applying...';
        }
        if (progress) {
          progress.classList.remove('d-none');
        }
        if (progressBar && progressValue) {
          let pct = 0;
          progressBar.style.width = '0%';
          progressValue.textContent = '0%';
          const timer = setInterval(function () {
            pct = Math.min(95, pct + Math.floor(Math.random() * 4) + 1);
            progressBar.style.width = pct + '%';
            progressValue.textContent = pct + '%';
            if (pct >= 95) {
              clearInterval(timer);
            }
          }, 120);
        }
      });
    });
  })();
</script>
{% endblock %}
