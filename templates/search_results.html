{% extends "base.html" %}
{% block title %}Search: {{ query }}{% endblock %}
{% block content %}
<h2 class="mb-3">Search Results</h2>

<form method="get" action="{% url 'search' %}" class="mb-4">
  <div class="input-group" style="max-width:500px;">
    <input type="text" name="q" class="form-control" placeholder="Case #, parcel ID, address, name..." value="{{ query }}">
    <button class="btn btn-primary" type="submit">Search</button>
  </div>
</form>

{% if query and query|length >= 2 %}

{# Prospect Results #}
<div class="card mb-4">
  <div class="card-header">
    <strong>Prospects</strong>
    <span class="badge bg-secondary">{{ prospects|length }}</span>
  </div>
  {% if prospects %}
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle mb-0">
      <thead class="table-dark">
        <tr>
          <th>Case #</th>
          <th>Parcel ID</th>
          <th>Address</th>
          <th>Auction Date</th>
          <th class="text-end">Surplus</th>
          <th>Qualification</th>
          <th class="text-center">AC</th>
          <th class="text-center">TDM</th>
          <th>Workflow</th>
          <th>Assigned To</th>
          <th>State</th>
          <th>County</th>
          <th>Type</th>
        </tr>
      </thead>
      <tbody>
        {% for prospect in prospects %}
        <tr>
          <td>
            <a href="{% url 'prospects:detail' prospect.pk %}" class="fw-semibold link-primary link-underline-opacity-0 link-underline-opacity-100-hover">
              {{ prospect.case_number }}
              <i class="bi bi-file-earmark-text ms-1 small"></i>
            </a>
          </td>
          <td>
            {% if prospect.parcel_id %}
              <a href="{% if prospect.parcel_url %}{{ prospect.parcel_url }}{% else %}https://apps.miamidadepa.gov/PropertySearch/#/?folio={{ prospect.parcel_id|cut:'-' }}{% endif %}"
                 class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover fw-medium"
                 target="_blank"
                 rel="noopener">
                {{ prospect.parcel_id }}
                <i class="bi bi-globe2 ms-1 small"></i>
              </a>
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if prospect.property_address or prospect.city or prospect.zip_code %}
              <div>{{ prospect.property_address|default:"" }}</div>
              <div class="text-muted small">
                {% if prospect.city %}{{ prospect.city }}{% endif %}{% if prospect.city and prospect.zip_code %}, {% endif %}{% if prospect.zip_code %}{{ prospect.zip_code }}{% endif %}
              </div>
            {% else %}
              -
            {% endif %}
          </td>
          <td>{{ prospect.auction_date|date:"m/d/Y"|default:"-" }}</td>
          <td class="text-end">{% if prospect.surplus_amount %}${{ prospect.surplus_amount|floatformat:2 }}{% else %}-{% endif %}</td>
          <td>
            {% if prospect.qualification_status == 'qualified' %}
              <span class="badge bg-success">Qualified</span>
            {% elif prospect.qualification_status == 'disqualified' %}
              <span class="badge bg-danger">Disqualified</span>
            {% else %}
              <span class="badge bg-warning text-dark">Pending</span>
            {% endif %}
          </td>
          <td class="text-center">
            {% if prospect.ack_url %}
              {% if user.profile.is_admin %}
                <a href="{{ prospect.ack_url }}" target="_blank" rel="noopener" class="text-success" title="Open AC URL">
                  <i class="bi bi-check-circle-fill fs-5"></i>
                </a>
              {% else %}
                <span class="text-success" title="AC URL available">
                  <i class="bi bi-check-circle-fill fs-5"></i>
                </span>
              {% endif %}
            {% else %}
              <span class="text-danger" title="AC URL not available">
                <i class="bi bi-x-circle-fill fs-5"></i>
              </span>
            {% endif %}
          </td>
          <td class="text-center">
            {% if prospect.tdm_url %}
              {% if user.profile.is_admin %}
                <a href="{{ prospect.tdm_url }}" target="_blank" rel="noopener" class="text-success" title="Open TDM URL">
                  <i class="bi bi-check-circle-fill fs-5"></i>
                </a>
              {% else %}
                <span class="text-success" title="TDM URL available">
                  <i class="bi bi-check-circle-fill fs-5"></i>
                </span>
              {% endif %}
            {% else %}
              <span class="text-danger" title="TDM URL not available">
                <i class="bi bi-x-circle-fill fs-5"></i>
              </span>
            {% endif %}
          </td>
          <td>
            {% if prospect.workflow_status == 'new' %}
              <span class="badge bg-secondary">New</span>
            {% elif prospect.workflow_status == 'assigned' %}
              <span class="badge bg-primary">Assigned</span>
            {% elif prospect.workflow_status == 'researching' %}
              <span class="badge bg-info text-dark">Researching</span>
            {% elif prospect.workflow_status == 'skip_tracing' %}
              <span class="badge bg-warning text-dark">Skip Trace</span>
            {% elif prospect.workflow_status == 'contacting' %}
              <span class="badge bg-warning">Contacting</span>
            {% elif prospect.workflow_status == 'contract_sent' %}
              <span class="badge bg-success">Contract Sent</span>
            {% elif prospect.workflow_status == 'converted' %}
              <span class="badge bg-success">Converted</span>
            {% elif prospect.workflow_status == 'dead' %}
              <span class="badge bg-danger">Dead</span>
            {% else %}
              <span class="badge bg-light text-dark">{{ prospect.workflow_status }}</span>
            {% endif %}
          </td>
          <td>{% if prospect.assigned_to %}{{ prospect.assigned_to.get_full_name|default:prospect.assigned_to.username }}{% else %}<span class="text-muted">Unassigned</span>{% endif %}</td>
          <td>{{ prospect.county.state.abbreviation }}</td>
          <td>{{ prospect.county.name }}</td>
          <td><span class="badge bg-secondary">{{ prospect.get_prospect_type_display }}</span></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="card-body text-muted">No prospects found.</div>
  {% endif %}
</div>

{# Case Results #}
<div class="card mb-4">
  <div class="card-header">
    <strong>Cases</strong>
    <span class="badge bg-secondary">{{ cases|length }}</span>
  </div>
  {% if cases %}
  <div class="table-responsive">
    <table class="table table-hover table-sm mb-0">
      <thead class="table-dark">
        <tr>
          <th>Type</th>
          <th>Case #</th>
          <th>County</th>
          <th>Address</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for c in cases %}
        <tr>
          <td><span class="badge bg-secondary">{{ c.get_case_type_display }}</span></td>
          <td><a href="{% url 'cases:detail' c.pk %}">{{ c.case_number|default:c.pk }}</a></td>
          <td>{{ c.county.name }}</td>
          <td>{{ c.property_address|default:"-"|truncatechars:40 }}</td>
          <td>{{ c.get_status_display }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="card-body text-muted">No cases found.</div>
  {% endif %}
</div>

{% elif query %}
<p class="text-muted">Please enter at least 2 characters to search.</p>
{% else %}
<p class="text-muted">Enter a search term above.</p>
{% endif %}
{% endblock %}

